<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="江湖の林九">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="江湖の林九">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Leo Lin">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>江湖の林九</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">江湖の林九</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">相逢何必曾相识！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/22/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-KNN%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Leo Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江湖の林九">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/22/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-KNN%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">KNN原理与实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-22 10:00:00" itemprop="dateCreated datePublished" datetime="2019-12-22T10:00:00+08:00">2019-12-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-24 15:29:25" itemprop="dateModified" datetime="2020-04-24T15:29:25+08:00">2020-04-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" itemprop="url" rel="index"><span itemprop="name">人工智能</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="算法概览"><a href="#算法概览" class="headerlink" title="算法概览"></a>算法概览</h2><p><img src="/images/18-ml/1-algorithm.png"></p>
<h2 id="KNN原理"><a href="#KNN原理" class="headerlink" title="KNN原理"></a>KNN原理</h2><p>KNN属于监督学习，如果一个样本在特征空间中的k个最相似（即特征空间中最邻近的样本中的大多数属于某一个类别），则该样本也属于这个类别。<br><img src="/images/18-ml/2-knn.png"></p>
<h3 id="距离计算"><a href="#距离计算" class="headerlink" title="距离计算"></a>距离计算</h3><p>两个样本的距离可以通过如下公式计算欧式距离，如a(a1,a2,a3)，b(b1,b2,b3)<br><img src="/images/18-ml/3-EuclideanDistance.png"></p>
<h2 id="KNN-python示例"><a href="#KNN-python示例" class="headerlink" title="KNN python示例"></a>KNN python示例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createDataSet</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    给出训练数据以及对应的类别</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    group = array([[<span class="number">1.0</span>, <span class="number">1.1</span>], [<span class="number">1.0</span>, <span class="number">1.0</span>], [<span class="number">0</span>, <span class="number">0</span>], [<span class="number">0</span>, <span class="number">0.1</span>]])</span><br><span class="line"></span><br><span class="line">    labels = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;B&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> group, labels</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">classify0</span>(<span class="params">inX, dataSet, labels, k</span>):</span></span><br><span class="line">    <span class="comment"># (4,2)</span></span><br><span class="line">    dataSetSize = dataSet.shape[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 1、距离计算 numpy tile 将原矩阵横向、纵向地复制</span></span><br><span class="line">    diffMat = tile(inX, (dataSetSize, <span class="number">1</span>)) - dataSet</span><br><span class="line"></span><br><span class="line">    sqDiffMat = diffMat ** <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    sqDistances = sqDiffMat.sum(axis=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    distances = sqDistances ** <span class="number">0.5</span></span><br><span class="line">    print(<span class="string">f&quot;distance:<span class="subst">&#123;distances&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># argsort函数返回的是数组值从小到大的索引值</span></span><br><span class="line">    sortedDistIndicies = distances.argsort()</span><br><span class="line">    print(sortedDistIndicies)</span><br><span class="line">    <span class="comment"># 2、选取距离最小的K个点</span></span><br><span class="line">    classCount = dict()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 统计A和B的个数，存在</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(k):</span><br><span class="line">        voteIlabel = labels[sortedDistIndicies[i]]</span><br><span class="line"></span><br><span class="line">        classCount[voteIlabel] = classCount.get(voteIlabel, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">    <span class="comment"># 排序</span></span><br><span class="line">    sortedClassCount = sorted(classCount.items(), key=operator.itemgetter(<span class="number">1</span>), reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sortedClassCount[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    group, labels = createDataSet()</span><br><span class="line">    print(classify0([<span class="number">0</span>, <span class="number">0</span>], group, labels, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>

<h2 id="sklearn-KNN-API"><a href="#sklearn-KNN-API" class="headerlink" title="sklearn KNN API"></a>sklearn KNN API</h2><p>1、分类器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">KNeighborsClassifier</span>(<span class="params">n_neighbors = <span class="number">5</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                       weights=<span class="string">&#x27;uniform&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                       algorithm = <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                       leaf_size = <span class="string">&#x27;30&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                       p = <span class="number">2</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                       metric = <span class="string">&#x27;minkowski&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                       metric_params = None,</span></span></span><br><span class="line"><span class="function"><span class="params">                       n_jobs = None</span></span></span><br><span class="line"><span class="function"><span class="params">                       </span>)</span></span><br><span class="line"><span class="function">```       </span></span><br><span class="line"><span class="function">                        </span></span><br><span class="line"><span class="function">- <span class="title">n_neighbors</span>：这个值就是指 <span class="title">KNN</span> 中的 “<span class="title">K</span>”了。前面说到过，通过调整 <span class="title">K</span> 值，算法会有不同的效果。</span></span><br><span class="line"><span class="function">- <span class="title">weights</span>（权重）：最普遍的 <span class="title">KNN</span> 算法无论距离如何，权重都一样，但有时候我们想搞点特殊化，比如距离更近的点让它更加重要。这时候就需要 <span class="title">weight</span> 这个参数了，这个参数有三个可选参数的值，决定了如何分配权重。参数选项如下：</span></span><br><span class="line"><span class="function">        • &#x27;<span class="title">uniform</span>&#x27;：不管远近权重都一样，就是最普通的 <span class="title">KNN</span> 算法的形式。</span></span><br><span class="line"><span class="function">        • &#x27;<span class="title">distance</span>&#x27;：权重和距离成反比，距离预测目标越近具有越高的权重。</span></span><br><span class="line"><span class="function">        • 自定义函数：自定义一个函数，根据输入的坐标值返回对应的权重，达到自定义权重的目的。</span></span><br><span class="line"><span class="function">- <span class="title">algorithm</span>：在 <span class="title">sklearn</span> 中，要构建 <span class="title">KNN</span> 模型有三种构建方式，1. 暴力法，就是直接计算距离存储比较的那种放松。2. 使用 <span class="title">kd</span> 树构建 <span class="title">KNN</span> 模型 3. 使用球树构建。 其中暴力法适合数据较小的方式，否则效率会比较低。如果数据量比较大一般会选择用 <span class="title">KD</span> 树构建 <span class="title">KNN</span> 模型，而当 <span class="title">KD</span> 树也比较慢的时候，则可以试试球树来构建 <span class="title">KNN</span>。参数选项如下：</span></span><br><span class="line"><span class="function">        • &#x27;<span class="title">brute</span>&#x27; ：蛮力实现</span></span><br><span class="line"><span class="function">        • &#x27;<span class="title">kd_tree</span>&#x27;：<span class="title">KD</span> 树实现 <span class="title">KNN</span></span></span><br><span class="line"><span class="function">        • &#x27;<span class="title">ball_tree</span>&#x27;：球树实现 <span class="title">KNN</span> </span></span><br><span class="line"><span class="function">        • &#x27;<span class="title">auto</span>&#x27;： 默认参数，自动选择合适的方法构建模型</span></span><br><span class="line"><span class="function">		不过当数据较小或比较稀疏时，无论选择哪个最后都会使用 &#x27;<span class="title">brute</span>&#x27;</span></span><br><span class="line"><span class="function">        </span></span><br><span class="line"><span class="function">- <span class="title">leaf_size</span>：如果是选择蛮力实现，那么这个值是可以忽略的，当使用<span class="title">KD</span>树或球树，它就是是停止建子树的叶子节点数量的阈值。默认30，但如果数据量增多这个参数需要增大，否则速度过慢不说，还容易过拟合。</span></span><br><span class="line">- p：和metric结合使用的，当metric参数是&quot;minkowski&quot;的时候，p=1为曼哈顿距离， p=2为欧式距离。默认为p=2。</span><br><span class="line">- metric：指定距离度量方法，一般都是使用欧式距离。</span><br><span class="line">        • <span class="string">&#x27;euclidean&#x27;</span> ：欧式距离</span><br><span class="line">        • <span class="string">&#x27;manhattan&#x27;</span>：曼哈顿距离</span><br><span class="line">        • <span class="string">&#x27;chebyshev&#x27;</span>：切比雪夫距离</span><br><span class="line">        • <span class="string">&#x27;minkowski&#x27;</span>： 闵可夫斯基距离，默认参数</span><br><span class="line">- n_jobs：指定多少个CPU进行运算，默认是<span class="number">-1</span>，也就是全部都算</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、评估模型的预测性能</span><br><span class="line">```python</span><br><span class="line">sklearn.cross_validation.cross_val_score(estimator, X, y=<span class="literal">None</span>, scoring=<span class="literal">None</span>,</span><br><span class="line">cv=<span class="literal">None</span>, n_jobs=<span class="number">1</span>, verbose=<span class="number">0</span>, fit_params=<span class="literal">None</span>, pre_dispatch=<span class="string">&#x27;2*n_jobs&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>estimator：分类器即使用的算法</li>
<li>cv：cv参数决定数据集划分比例，当cv的取值为整数的时候，使用(Stratified)KFold方法。如cv=10则数据集划分为10折，每次用9折训练，1折测试，就会有10次结果，求十次的平均即可。</li>
<li>scoring：决定了其中的分数计算方法(包括accuracy和mean_squared_error等)</li>
</ul>
<p>3、划分测试集和训练集</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X_train,X_test, y_train, y_test =cross_validation.train_test_split(train_data,train_target,test_size=<span class="number">0.3</span>, random_state=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>x           数据集的特征值</li>
<li>y        数据集的标签值</li>
<li>test_size      测试集的大小，一般为float，在0-1之间，表示样本占比；如果是整数的话就是样本的数量</li>
<li>random_state        随机数种子,不同的种子会造成不同的随机采样结果。相同的种子采样结果相同</li>
<li>return  训练集特征值，测试集特征值，训练标签，测试标签(默认随机取)</li>
</ul>
<p>4、归一化处理<br>如果一个特征值域范围非常大，那么距离计算就主要取决于这个特征，从而与实际情况相悖。Sklearn 均值方差归一化把所有数据归一到均值为0方差为1的分布中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line">standardScaler = StandardScaler()</span><br><span class="line"><span class="comment"># 存放了均值方差归一化所对应的信息</span></span><br><span class="line">standardScaler.fit(X_train)</span><br><span class="line">X_train = standardScaler.transform(X_train)</span><br><span class="line">X_test = standardScaler.transform(X_test)</span><br></pre></td></tr></table></figure>

<p>5、KNeighborsClassifier对象进行fit创建出模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sklearn_knn_clf.fit(X_train,y_train)</span><br></pre></td></tr></table></figure>

<h2 id="KNN-sklearn示例"><a href="#KNN-sklearn示例" class="headerlink" title="KNN sklearn示例"></a>KNN sklearn示例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以鸢尾花的数据集为示例</span></span><br><span class="line">iris = datasets.load_iris()</span><br><span class="line">X = iris.data</span><br><span class="line">y = iris.target</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"></span><br><span class="line">X_train, x_test, y_train, y_test = train_test_split(X, y, test_size=<span class="number">0.2</span>, random_state=<span class="number">666</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler  <span class="comment"># sklearn中的相应的类</span></span><br><span class="line"></span><br><span class="line">standardScaler = StandardScaler()  <span class="comment"># 实例化这样的一个类</span></span><br><span class="line"></span><br><span class="line">standardScaler.fit(X_train)  <span class="comment"># 求出相应的均值和方差（根据训练集）</span></span><br><span class="line"></span><br><span class="line">standardScaler.mean_  <span class="comment"># 均值 array([5.83416667, 3.0825    , 3.70916667, 1.16916667])</span></span><br><span class="line"></span><br><span class="line">standardScaler.scale_  <span class="comment"># 标准差array([0.81019502, 0.44076874, 1.76295187, 0.75429833])</span></span><br><span class="line"></span><br><span class="line">X_train = standardScaler.transform(X_train)  <span class="comment"># 根据fit计算出来的值来进行相应的数据归一化</span></span><br><span class="line"></span><br><span class="line">x_test_transform = standardScaler.transform(x_test)  <span class="comment"># 对测试集也使用同样的方法进行相应的数据归一化</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"></span><br><span class="line">knn_clf = KNeighborsClassifier(n_neighbors=<span class="number">3</span>)</span><br><span class="line">knn_clf.fit(X_train, y_train)</span><br><span class="line"></span><br><span class="line">score = knn_clf.score(x_test_transform, y_test)  <span class="comment"># 数据归一化后的精确度1.0</span></span><br></pre></td></tr></table></figure>

<h2 id="Kaggle验证手机号小记："><a href="#Kaggle验证手机号小记：" class="headerlink" title="Kaggle验证手机号小记："></a>Kaggle验证手机号小记：</h2><p>1、确保自己可以科学上网，手机前加+860，点击发送。<br>2、先前选择的是用Google账号登录,但是点击之后一直显示”sending…”。<br>3、最后更换邮箱重新注册，一次验证通过。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/22/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-Scikit-Learn%E5%BA%93%E7%9A%84%E5%88%86%E7%B1%BB%E6%96%B9%E6%B3%95%E6%80%BB%E8%A7%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Leo Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江湖の林九">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/22/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-Scikit-Learn%E5%BA%93%E7%9A%84%E5%88%86%E7%B1%BB%E6%96%B9%E6%B3%95%E6%80%BB%E8%A7%88/" class="post-title-link" itemprop="url">Scikit-Learn库的分类方法总览</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-22 10:00:00" itemprop="dateCreated datePublished" datetime="2019-12-22T10:00:00+08:00">2019-12-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-24 16:50:16" itemprop="dateModified" datetime="2020-04-24T16:50:16+08:00">2020-04-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/" itemprop="url" rel="index"><span itemprop="name">人工智能</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>你是一个正在进入机器学习领域的Python程序员吗? 掌握Scikit-Learn就是一个开启你的旅程的很好的方式。<br>使用Scikit-Learn进行一些分类是应用你所学到的知识的一种直接而简单的方法，通过使用一个用户友好的、文档良好且健壮的库来实现这些分类可以让机器学习概念更具体化。</p>
<h2 id="什么是Scikit-Learn"><a href="#什么是Scikit-Learn" class="headerlink" title="什么是Scikit-Learn?"></a>什么是Scikit-Learn?</h2><p>Scikit-Learn是一个Python库，由David Cournapeau在2007年首次开发。它包含一系列容易实现和调整的有用算法，可以用来实现分类和其他机器学习任务的目的。<br>Scikit-Learn使用SciPy作为基础，因此在使用Scikit-Learn之前必须安装这个库的基础堆栈。</p>
<h2 id="定义术语"><a href="#定义术语" class="headerlink" title="定义术语"></a>定义术语</h2><p>在我们进一步探索Scikit-Learn之前，让我们花一分钟来定义我们的术语。理解描述Scikit-Learn功能时使用的词汇是很重要的。<br>首先，机器学习系统或网络接受输入和输出。机器学习框架的输入通常被称为“特征”。<br>特征本质上与科学实验中的变量相同，它们是被观察现象的特点，可以用某种方式量化或测量。<br>当这些特性被输入到机器学习框架中时，该网络就会尝试识别这些特征之间的相关模式。然后使用这些模式生成框架/网络的输出。<br>框架的输出通常被称为“分类”，因为输出特征会具有一些网络给予它们的标签，它是一些关于输出属于哪个类别的假设。</p>
<p><img src="/images/18-ml/8-plants.png"></p>
<p>在机器学习上下文中，分类是一种监督学习。监督学习是指输入网络的数据已经被标记，重要的特征/属性已经预先被划分为不同的类别。</p>
<p>这意味着网络知道输入的哪些部分是重要的，并且还有一个目标或标准答案，网络可以根据它来检查自己。分类的一个例子是把一堆不同的植物分类成不同的种类，比如蕨类植物或被子植物。这个任务可以通过一个决策树(Scikit-Learn中的一种分类器)来完成。</p>
<p>相反，无监督学习是指输入网络的数据没有被标记，而网络必须自己学习哪些特性是最重要的。如前所述，分类是一种类型的监督学习，因此我们在本文中将不讨论非监督学习方法。</p>
<p>模型的训练过程是将数据输入神经网络，让神经网络学习数据的模式的过程。训练过程接收数据并提取数据集的特征。在一个监督分类任务的训练过程中，网络既要传递训练数据的特征，又要传递训练数据的分类。但是，在测试过程中，只给网络传入特征。</p>
<p>测试过程是对网络学习到的模式进行测试的地方。特征被提供给网络，并且网络必须预测其分类。提供给网络的数据被分为训练集和测试集，这是两个不同的输入集。你不能使用训练分类器的同一个数据集来测试该分类器，因为这个模型已经学习了这组数据的模式，所以结果可能会偏差很大。</p>
<p>相反，如果数据集被分割成训练集和测试集，那么这样一来，一个是用来训练分类器的数据集，而另一个则是分类器从未见过的数据集。</p>
<h2 id="不同类型的分类器"><a href="#不同类型的分类器" class="headerlink" title="不同类型的分类器"></a>不同类型的分类器</h2><p>Scikit-Learn提供了对多种不同分类算法的简单访问。这些分类器包括:</p>
<ul>
<li>K最近邻算法</li>
<li>支持向量机</li>
<li>决策树分类器/随机森林</li>
<li>朴素贝叶斯</li>
<li>线性判别分析</li>
<li>逻辑回归</li>
</ul>
<p>有很多关于这些分类器如何运行的文献，你也可以在Scikit-Learn的网站上找到它们的简要解释。</p>
<p>由于这个原因，我们不打算在这里深入研究它们是如何工作的，但是会对分类器的工作方式进行简要的说明。</p>
<h3 id="K最近邻分类算法"><a href="#K最近邻分类算法" class="headerlink" title="K最近邻分类算法"></a>K最近邻分类算法</h3><p>K最近邻分类算法通过检查某个测试示例到某个训练示例的已知值之间的距离来进行计算。能给出训练点与测试点之间最小距离的一组数据点/类就是该算法所选择的类。</p>
<h3 id="决策树"><a href="#决策树" class="headerlink" title="决策树"></a>决策树</h3><p>决策树分类器通过根据不同的标准将数据集分解为越来越小的子集来进行计算。它会使用不同的排序标准来划分数据集，每划分一次，示例的数量就会减少。</p>
<p>一旦网络将数据划分为一个示例，这个示例将被放入一个对应于一个键的类中。当多个随机的森林分类器链接在一起时，它们就被称为随机森林分类器。</p>
<h3 id="朴素贝叶斯"><a href="#朴素贝叶斯" class="headerlink" title="朴素贝叶斯"></a>朴素贝叶斯</h3><p>一个朴素贝叶斯分类器会确定一个例子属于某个类的概率，它会计算在某个输入事件已经发生的情况下，某个事件发生的概率。</p>
<p>当它进行这种计算时，它会假定一个类的所有预测器都对结果具有相同的影响，即预测器是相互独立的。</p>
<h3 id="线性判别分析"><a href="#线性判别分析" class="headerlink" title="线性判别分析"></a>线性判别分析</h3><p>线性判别分析的工作原理是通过降低数据集的维度，将所有数据点投影到一条直线上。然后根据这些点与所选点或矩心的距离将它们组合成类。</p>
<p>和你所猜想的一样，线性判别分析是一种线性分类算法，最好在数据具有线性关系时使用。</p>
<h3 id="支持向量机"><a href="#支持向量机" class="headerlink" title="支持向量机"></a>支持向量机</h3><p><img src="/images/18-ml/9-vectors.png"><br>支持向量机的工作原理是在不同的数据点集群之间画一条线，将它们分组到一些类中。线的一边的点是一类，另一边的点属于另一类。</p>
<p>分类器会尝试最大化它所绘制的线与它两边的点之间的距离，以增加它对哪个点属于哪类的置信度。当测试点被绘制出来时，它们在直线的哪边就是它们所属的类。</p>
<h3 id="逻辑回归"><a href="#逻辑回归" class="headerlink" title="逻辑回归"></a>逻辑回归</h3><p>逻辑回归以二元范围 (0或1)输出关于测试数据点的预测。如果某个东西的值为0.5或以上，则将其划分为第1类，如果值低于0.5就属于第0类。</p>
<p>每个特征也只有0或1的分类。逻辑回归是一种线性分类器，因此当数据之间存在某种线性关系时就会用到它。</p>
<h2 id="分类任务的例子"><a href="#分类任务的例子" class="headerlink" title="分类任务的例子"></a>分类任务的例子</h2><p>分类任务是将样本放入两个或多个类中的任何任务。确定一个图片是猫还是狗就是一项分类任务，就像根据酸度和酒精含量等特征确定一瓶酒的质量一样。<br>根据手头的分类任务，你可能希望使用不同的分类器。例如，逻辑回归模型最适合于二元分类任务，即使存在多变量逻辑回归模型。<br>随着你获得的分类器经验越多，你就会对何时使用哪个分类器有更好的感觉。但是，通常的做法是实例化多个分类器，并比较它们之间的性能，然后选择性能最好的分类器。</p>
<h2 id="实现一个分类器"><a href="#实现一个分类器" class="headerlink" title="实现一个分类器"></a>实现一个分类器</h2><p>现在我们已经讨论了Scikit-Learn为我们提供的各种分类器，我们来看看如何实现一个分类器。<br>实现分类器的第一步是将所需要的分类器导入到Python中。我们来看看逻辑回归的import语句:<br><code>from sklearn.liner_model import LogisticRegression</code></p>
<p>下面是本文讨论的其他分类器的import语句:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.discriminant_analysis <span class="keyword">import</span> LinearDiscriminantAnalysis</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KNeighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.naive_bayes <span class="keyword">import</span> GaussianNb</span><br><span class="line"><span class="keyword">from</span> sklearn.tree <span class="keyword">import</span> DecisionTreeClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br></pre></td></tr></table></figure>

<p>Scikit-Learn还有其他分类器，它们各自的文档页面会展示如何导入它们。</p>
<p>在导入之后，你就必须实例化分类器。实例化是在Python程序中将分类器转换成存在的实例的过程，也就是创建分类器/对象的实例。</p>
<p>这通常只需要创建一个变量并调用与分类器关联的函数来完成:</p>
<p><code>logreg_clf = LogisticRegression()</code></p>
<p>现在需要对分类器进行训练。要做到这一点，分类器必须与训练数据相匹配。</p>
<p>训练特征和训练分类通过fit命令传入分类器:</p>
<p><code>logreg_clf.fit(features,labels)</code></p>
<p>分类器模型在训练数据上进行训练后，可以对测试数据进行预测了。</p>
<p>这很容易做到，你可以调用分类器上的预测命令，并为其提供预测所需的参数，这些参数是你的测试数据集中的特征:</p>
<p><code>logreg_clf.predict(test_features)</code></p>
<p>实例化、拟合/训练和预测这些步骤是Scikit-Learn中分类器的基本工作流。</p>
<p>然而，分类器的处理只是使用Scikit-Learn进行分类的一部分。在Scikit-Learn中分类的另一部分是处理数据。</p>
<p>为了理解处理分类器和处理数据是怎样作为一个整体分类任务结合在一起的，我们花点时间来理解机器学习管道。</p>
<h2 id="机器学习管道"><a href="#机器学习管道" class="headerlink" title="机器学习管道"></a>机器学习管道</h2><p>机器学习管道包括以下步骤:准备数据、创建训练/测试集、实例化分类器、训练分类器、进行预测、评估性能、调整参数。</p>
<p>在数据集上训练分类器的第一步是准备数据集——将数据转换为分类器所需的正确形式，并处理数据中的任何异常。如果数据中有缺失值、异常值或任何其他异常，这些数据点都要被处理，因为它们会对分类器的性能产生负面影响。这一步称为数据预处理。</p>
<p>数据预处理完成后，必须将数据分解为训练集和测试集。我们之前已经讨论了创建训练和测试集的基本原理，这可以通过一个非常有用的名为traintestsplit的函数在Scikit-Learn中轻松实现。</p>
<p>如前所述，分类器必须进行实例化并在训练数据上进行训练。然后就可以利用分类器进行预测。通过将分类器的预测与测试数据中分类的实际已知值进行比较，你就可以测量该分类器的准确度。</p>
<p>将假定的分类与实际分类进行比较并评估分类器的方法有很多。我们稍后将讨论这些不同的评估指标。现在，要知道，在测量了分类器的准确的之后，你可能会回过头来调整你的模型的参数，直到达到你满意的准确度为止(因为你的分类器不太可能在第一次运行时就达到你的期望)。</p>
<p>让我们看一个机器学习管道的例子，从处理数据到进行评估。</p>
<h2 id="示例分类器实现"><a href="#示例分类器实现" class="headerlink" title="示例分类器实现"></a>示例分类器实现</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> classificaction_report</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> confusion_matrix</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> accuracy_score</span><br><span class="line"><span class="keyword">from</span> sklearn.neighbors <span class="keyword">import</span> KneighborsClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.svm <span class="keyword">import</span> SVC</span><br></pre></td></tr></table></figure>
<p>由于iris数据集非常常见，Scikit-Learn实际上已经具有了，我们可以用以下命令进行加载:<br><code>sklearn.datasets.load_iris</code><br>不过，我们将在这里加载一个CSV文件，以便你了解如何加载和预处理数据。你可以在这里（<a target="_blank" rel="noopener" href="https://www.kaggle.com/uciml/iris">https://www.kaggle.com/uciml/iris</a>  ）下载这个csv文件。</p>
<p>只需将数据文件放在与Python文件相同的目录中。Pandas库有一个简单的加载数据的方法，即read_csv():</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data = pd.read_csv(<span class="string">&quot;iris.csv&quot;</span>)</span><br><span class="line">print(data.head(<span class="number">5</span>))</span><br></pre></td></tr></table></figure>

<p>因为数据集准备得很好，所以我们不需要进行很多预处理。我们可能会想做的一件事是删除“ID”列，因为它只是对示例所在行的一个表示。</p>
<p>由于这一列并没有任何帮助，所以我们可以使用drop()函数从数据集中删除它:<br><code>data.drop(&#39;Id&#39;,axis=1,inplace=True)</code></p>
<p>现在我们需要定义特征和分类。我们可以使用Pandas库通过对数据表进行切片，并使用iloc()选择特定的行/列来轻松地实现这一点:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = data.iloc[:,:<span class="number">-1</span>].values</span><br><span class="line"></span><br><span class="line">y = data[<span class="string">&#x27;Species&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>上面的切片符号会选择除最后一列(这是我们的分类，物种)之外的每一行和每一列。<br>或者，你也可以通过使用括号符号和传递列标头来选择你感兴趣的某些数据集特性:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Alternate way of selecting columns:</span></span><br><span class="line">x = data.iloc[<span class="string">&#x27;SepalLengthCm&#x27;</span>,<span class="string">&#x27;SepalWidthCm&#x27;</span>,<span class="string">&#x27;PetalLengthCm&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>现在我们已经有了我们想要的特征和分类，我们可以使用sklearn的train_test_split()函数将数据分割为训练集和测试集:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Test size specifies how much of the data you want to set aside for the testing set.</span></span><br><span class="line"><span class="comment"># Random_state parameter is just a random seed we can use.</span></span><br><span class="line"><span class="comment"># You can use it if you&#x27;d like to reproduce these specific result.</span></span><br><span class="line">x-train,x_test,y_train,y_test = train_test_split(x,y,test_size=<span class="number">0.20</span>,random_state=<span class="number">27</span>)</span><br></pre></td></tr></table></figure>

<p>你可能想打印结果，以确保你的数据正在按照你所期望的方式被解析:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(x_train)</span><br><span class="line">print(y_train)</span><br></pre></td></tr></table></figure>

<p>现在我们可以实例化这个模型。我们尝试使用两个分类器，一个支持向量分类器和一个k最近邻分类器:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SVC_model = svm.SVC()</span><br><span class="line">KNN_model = KNeighborsClassifier(n_neighbors=<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p>现在我们来适应分类器:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SVC_model.fit(x_train,y_train)</span><br><span class="line">KNN_model.fit(x_train,y_train)</span><br></pre></td></tr></table></figure>

<p>以上调用已经训练了这个模型，现在我们可以进行预测并将预测结果存储在一个变量中:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SVC_prediction = SVC_model.predict(x_test)</span><br><span class="line">KNN_prediction = KNN_model.predict(x_test)</span><br></pre></td></tr></table></figure>

<p>现在我们应该评估一下分类器的运行情况。有多种方法可以用来评估一个分类器的性能，你可以在下面阅读关于这些不同方法的更多信息。</p>
<p>在Scikit-Learn中，你只需要输入与你测试标签中存储的真实分类相对的预测结果即可:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">print(accuracy_score(SVC_prediction,y_test))</span><br><span class="line">print(accuracy_score(KNN_prediction,y_test))</span><br><span class="line"></span><br><span class="line">print(confusion_matrix(SVC_prediction,y_test))</span><br><span class="line">print(classification_report(KNN_prediction,y_test))</span><br></pre></td></tr></table></figure>


<p>作为参考，下面是我们得到的关于指标的输出:</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">SVC</span> accuracy:<span class="number">0</span>.<span class="number">9333333333333</span></span><br><span class="line"><span class="attribute">KNN</span> accuracy:<span class="number">0</span>.<span class="number">9666666666667</span></span><br></pre></td></tr></table></figure>

<p>乍一看，KNN的表现似乎更好。这是SVC的混淆矩阵:</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[ <span class="number">7</span> <span class="number">0</span> <span class="number">0</span> ]</span><br><span class="line"> [<span class="number">0</span> <span class="number">10</span> <span class="number">1</span>]</span><br><span class="line"> [<span class="number">0</span> <span class="number">1</span> <span class="number">11</span>]]</span><br></pre></td></tr></table></figure>


<p>这可能有点难以解释，但是每个类的正确预测数都是从左上角到右下角的对角线上运行的。查看下面的更多信息。</p>
<p>最后，这是KNN分类报告的输出:<br><img src="/images/18-ml/10-knnoutput.png"></p>
<h2 id="评估分类器"><a href="#评估分类器" class="headerlink" title="评估分类器"></a>评估分类器</h2><p>在评估你的分类器时，有几种不同的方法可以用来测量它的性能。</p>
<h3 id="分类准确度"><a href="#分类准确度" class="headerlink" title="分类准确度"></a>分类准确度</h3><p>分类准确度是所有评估准确性的方法中最简单的，也是最常用的。分类准确度就是正确预测的数量除以所有预测或者正确预测与总预测的比例。<br>虽然它可以让你快速了解分类器的执行情况，但是最好在每个类中的观察值/示例数量大致相当时再使用它。因为这种情况不会经常发生，所以你最好使用另一种指标方法。</p>
<h2 id="对数损失"><a href="#对数损失" class="headerlink" title="对数损失"></a>对数损失</h2><p>对数损失,或LogLoss,本质上是评估分类器对其预测结果的自信程度。LogLoss会返回给定类中一个示例中成员的概率，将它们加起来表示分类器的总体信心。<br>针对预测的值取值为1到0,1表示完全自信，0表示不自信。损失，或者信心的总缺乏度，以负数的形式返回，0表示一个完美的分类器，所以值越小越好。</p>
<h2 id="ROC曲线下与坐标轴围成的面积-AUC"><a href="#ROC曲线下与坐标轴围成的面积-AUC" class="headerlink" title="ROC曲线下与坐标轴围成的面积(AUC)"></a>ROC曲线下与坐标轴围成的面积(AUC)</h2><p>这是一个仅用于二元分类问题的指标。曲线下的面积代表了模型正确区分正负样本的能力，以及区分一个类和另一个类的能力。<br>落在曲线下的面积总和为1.0，这代表一个完美的分类器。这意味着AUC为0.5基本上和随机猜测一样好。ROC曲线根据灵敏度(真阳率/召回率)和特异性(真阴率)计算。你可以在这篇ROC曲线文章中阅读更多关于这些计算的内容。</p>
<h2 id="混淆矩阵"><a href="#混淆矩阵" class="headerlink" title="混淆矩阵"></a>混淆矩阵</h2><p>混淆矩阵是一个表或图表，表示模型相对于两个或多个类的准确性。模型的预测用x轴表示，而结果/准确度用y轴表示。<br>这个单元格中被填入了模型做出的预测数量。正确的预测可以在从左上角到右下角的对角线上找到。你可以在这里阅读更多关于解释混淆矩阵的内容。</p>
<h2 id="分类报告"><a href="#分类报告" class="headerlink" title="分类报告"></a>分类报告</h2><p>分类报告是一种Scikit-Learn的内置指标，专门针对分类问题而创建。使用分类报告可以让你快速直观地了解模型的执行情况。召回率会将你的模型标记为类A(某些给定的类)的样本数量与类A的样本总数进行比较，这在报告中会表示出来。<br>该报告还返回预测和f1得分。精确度是您的模型被标记为类A的实例的百分比，它实际上属于类A(真阳性对假阳性)，而f1-score是精确度和召回率的平均值。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>为了进一步加深你对Scikit-Learn的理解，你最好多了解一些可用的不同分类算法。一旦你理解了这些算法，阅读更多关于如何评估分类器的内容。<br>分类的许多细微差别只是随着时间和实践而来的，但是如果你按照本指南中的步骤，那你将会在成为一个使用Scikit-Learn处理分类任务的专家的道路上走得很好。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/27/Cookie%20Session%20Cookiejar/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Leo Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江湖の林九">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/27/Cookie%20Session%20Cookiejar/" class="post-title-link" itemprop="url">Cookie Session Cookiejar</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-27 12:25:00" itemprop="dateCreated datePublished" datetime="2019-11-27T12:25:00+08:00">2019-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-24 14:48:10" itemprop="dateModified" datetime="2020-04-24T14:48:10+08:00">2020-04-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/" itemprop="url" rel="index"><span itemprop="name">网络爬虫</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h2><ul>
<li>持久化: 保存到本地磁盘上，在设置的expire时间内关闭浏览器后依然有效。</li>
<li>非持久化: 储存在浏览器内存中，关闭则失效。<br>Cookie是服务器在本地机器上存储的小段文本，可以用于保存用户喜好、用户名密码、用户喜欢的网页背景色，并随每一个请求发送至同一个服务器。<br>Cookie的内容主要包括：名字，值，过期时间，路径和域，路径与域一起构成cookie的作用范围。<br>格式：<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">客户端发送Cookie（键值对）：Cookie：<span class="attribute">key1</span>=value1; <span class="attribute">key2</span>=value2; <span class="attribute">key3</span>=value3</span><br><span class="line">服务器响应Cookie：Set-Cookie: <span class="attribute">name</span>=value；expires=date；path=path；domain=domain_name；secure</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><p>session机制借助于cookie机制在客户端保存标识达到在服务器端保持状态，用一个sessionID来区分是哪个用户session变量,这个值是通过用户的浏览器在访问的时候返回给服务器。<br>session是在服务端保存的一个数据结构，用来跟踪用户的状态，数据可以保存在集群、数据库、文件中，能够存取任何类型的数据，不限于String、Integer、List、Map。<br>sessionID是客户端第一次访问服务器的时候生成的，传递回服务器的方式除Cookie外还有URL重写、表单隐藏字段。</p>
<h2 id="application"><a href="#application" class="headerlink" title="application"></a>application</h2><p>Session保管在服务端，若并发访问的用户十分多，会耗费大量内存，因此对于大体量网站，Cookie是优先选择。<br>Cookie支持跨域名访问。</p>
<h2 id="Scrapy-CookieMiddle"><a href="#Scrapy-CookieMiddle" class="headerlink" title="Scrapy CookieMiddle"></a>Scrapy CookieMiddle</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> six</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> scrapy.exceptions <span class="keyword">import</span> NotConfigured</span><br><span class="line"><span class="keyword">from</span> scrapy.http <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> scrapy.http.cookies <span class="keyword">import</span> CookieJar</span><br><span class="line"><span class="keyword">from</span> scrapy.utils.python <span class="keyword">import</span> to_native_str</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CookiesMiddleware</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;This middleware enables working with sites that need cookies&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 中间件在Scrapy启动时实例化</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, debug=False</span>):</span></span><br><span class="line">    <span class="comment"># jars属性是一个默认值为CookieJar对象的dict.</span></span><br><span class="line">        self.jars = defaultdict(CookieJar)</span><br><span class="line">        self.debug = debug</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span>(<span class="params">cls, crawler</span>):</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> crawler.settings.getbool(<span class="string">&#x27;COOKIES_ENABLED&#x27;</span>):</span><br><span class="line">            <span class="keyword">raise</span> NotConfigured</span><br><span class="line">        <span class="keyword">return</span> cls(crawler.settings.getbool(<span class="string">&#x27;COOKIES_DEBUG&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span>(<span class="params">self, request, spider</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.meta.get(<span class="string">&#x27;dont_merge_cookies&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">		<span class="comment"># 每个cookiesjar的key都存储在 meta字典中，如果在request meta中使用了cookiejar, cookiejarkey为对应的标识，否则为None</span></span><br><span class="line">        cookiejarkey = request.meta.get(<span class="string">&quot;cookiejar&quot;</span>)</span><br><span class="line">        jar = self.jars[cookiejarkey]</span><br><span class="line">        <span class="comment"># 第一次执行jars会为每个key产生一个默认值cookiejar对象.默认为&#123;None: cookiejar&#125;</span></span><br><span class="line">        cookies = self._get_request_cookies(jar, request)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 把requests的cookies存储到cookiesjar中</span></span><br><span class="line">        <span class="keyword">for</span> cookie <span class="keyword">in</span> cookies:</span><br><span class="line">            jar.set_cookie_if_ok(cookie, request)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># set Cookie header</span></span><br><span class="line">        request.headers.pop(<span class="string">&#x27;Cookie&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="comment"># 添加cookiesjar中的cookies到requests header</span></span><br><span class="line">        jar.add_cookie_header(request)</span><br><span class="line">        self._debug_cookie(request, spider)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span>(<span class="params">self, request, response, spider</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.meta.get(<span class="string">&#x27;dont_merge_cookies&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">        <span class="comment"># extract cookies from Set-Cookie and drop invalid/expired cookies</span></span><br><span class="line">        cookiejarkey = request.meta.get(<span class="string">&quot;cookiejar&quot;</span>)</span><br><span class="line">        jar = self.jars[cookiejarkey]</span><br><span class="line">        <span class="comment"># 在请求允许的情况下(?),从response中提取cookie并入当前的cookiejar</span></span><br><span class="line">        jar.extract_cookies(response, request)</span><br><span class="line">        self._debug_set_cookie(response, spider)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_debug_cookie</span>(<span class="params">self, request, spider</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.debug:</span><br><span class="line">            cl = [to_native_str(c, errors=<span class="string">&#x27;replace&#x27;</span>)</span><br><span class="line">                  <span class="keyword">for</span> c <span class="keyword">in</span> request.headers.getlist(<span class="string">&#x27;Cookie&#x27;</span>)]</span><br><span class="line">            <span class="keyword">if</span> cl:</span><br><span class="line">                cookies = <span class="string">&quot;\n&quot;</span>.join(<span class="string">&quot;Cookie: &#123;&#125;\n&quot;</span>.format(c) <span class="keyword">for</span> c <span class="keyword">in</span> cl)</span><br><span class="line">                msg = <span class="string">&quot;Sending cookies to: &#123;&#125;\n&#123;&#125;&quot;</span>.format(request, cookies)</span><br><span class="line">                logger.debug(msg, extra=&#123;<span class="string">&#x27;spider&#x27;</span>: spider&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_debug_set_cookie</span>(<span class="params">self, response, spider</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.debug:</span><br><span class="line">            cl = [to_native_str(c, errors=<span class="string">&#x27;replace&#x27;</span>)</span><br><span class="line">                  <span class="keyword">for</span> c <span class="keyword">in</span> response.headers.getlist(<span class="string">&#x27;Set-Cookie&#x27;</span>)]</span><br><span class="line">            <span class="keyword">if</span> cl:</span><br><span class="line">                cookies = <span class="string">&quot;\n&quot;</span>.join(<span class="string">&quot;Set-Cookie: &#123;&#125;\n&quot;</span>.format(c) <span class="keyword">for</span> c <span class="keyword">in</span> cl)</span><br><span class="line">                msg = <span class="string">&quot;Received cookies from: &#123;&#125;\n&#123;&#125;&quot;</span>.format(response, cookies)</span><br><span class="line">                logger.debug(msg, extra=&#123;<span class="string">&#x27;spider&#x27;</span>: spider&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_format_cookie</span>(<span class="params">self, cookie</span>):</span></span><br><span class="line">        <span class="comment"># build cookie string</span></span><br><span class="line">        <span class="comment"># 对以字典或字典的列表的形式传入的cookie进行格式化</span></span><br><span class="line">        cookie_str = <span class="string">&#x27;%s=%s&#x27;</span> % (cookie[<span class="string">&#x27;name&#x27;</span>], cookie[<span class="string">&#x27;value&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> cookie.get(<span class="string">&#x27;path&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            cookie_str += <span class="string">&#x27;; Path=%s&#x27;</span> % cookie[<span class="string">&#x27;path&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> cookie.get(<span class="string">&#x27;domain&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            cookie_str += <span class="string">&#x27;; Domain=%s&#x27;</span> % cookie[<span class="string">&#x27;domain&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cookie_str</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_request_cookies</span>(<span class="params">self, jar, request</span>):</span></span><br><span class="line">		<span class="comment"># 将request中cookies参数添加的cookie合并到当前的cookiejar中</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(request.cookies, dict):</span><br><span class="line">            cookie_list = [&#123;<span class="string">&#x27;name&#x27;</span>: k, <span class="string">&#x27;value&#x27;</span>: v&#125; <span class="keyword">for</span> k, v <span class="keyword">in</span> \</span><br><span class="line">                    six.iteritems(request.cookies)]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cookie_list = request.cookies</span><br><span class="line"></span><br><span class="line">        cookies = [self._format_cookie(x) <span class="keyword">for</span> x <span class="keyword">in</span> cookie_list]</span><br><span class="line">        headers = &#123;<span class="string">&#x27;Set-Cookie&#x27;</span>: cookies&#125;</span><br><span class="line">        <span class="comment"># 使用刚才获取的cookie构造一个响应对象</span></span><br><span class="line">        response = Response(request.url, headers=headers)</span><br><span class="line">		<span class="comment"># cookiejar.make_cookies方法从response中提取cookie放入当前cookiejar中.</span></span><br><span class="line">        <span class="keyword">return</span> jar.make_cookies(response, request)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/10/Python%20%E5%85%83%E7%B1%BB%20%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F%20%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%20%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Leo Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江湖の林九">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/10/Python%20%E5%85%83%E7%B1%BB%20%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F%20%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%20%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">Python 元类 工厂模式 单例模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-10 10:00:00" itemprop="dateCreated datePublished" datetime="2019-11-10T10:00:00+08:00">2019-11-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-24 10:08:23" itemprop="dateModified" datetime="2020-04-24T10:08:23+08:00">2020-04-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%B6%B3%E8%BF%B9/" itemprop="url" rel="index"><span itemprop="name">编程足迹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="抽象基类"><a href="#抽象基类" class="headerlink" title="抽象基类"></a>抽象基类</h2><p>1、抽象类：主要定义了基本类和最基本的抽象方法，相当于Java中的接口。<br>2、抽象方法：基类中通过@abc.abstractmethod装饰器修饰的方法。<br>3、抽象基类不能被实例化(不能创建对象)，通常是作为基类供子类继承，子类中重写虚函数，实现具体的接口。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> abc        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cow</span>(<span class="params">metaclass=abc.ABCMeta</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;__init__ is called!&#x27;</span>)</span><br><span class="line">	<span class="comment"># 抽象方法</span></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prt</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&quot;1234&quot;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 定义子类，若子类未实现prt方法实例化报错</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">son</span>(<span class="params">cow</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prt</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 在子类中可以通过super()来调用父类方法</span></span><br><span class="line">        super().prt()</span><br><span class="line">        print(<span class="string">&quot;5678&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="元类"><a href="#元类" class="headerlink" title="元类"></a>元类</h2><p>1、object类和type类的关系：Python 中的类是 type 类的实例，object 是 type 的实例，而 type 是 object 的子类，所有类都是 type 的实例，但是元类还是 type的子类。<br>2、type(类名, 父类的元组（针对继承的情况，可以为空），包含属性的字典（名称和值）)<br>name: 生产的类名<br>bases：基类的tuple,无父类则为()<br>dict：字典形式类的所有属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpperAttrMetaclass</span>(<span class="params">type</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, name, bases, dct</span>):</span></span><br><span class="line">        attrs = ((name, value) <span class="keyword">for</span> name, value <span class="keyword">in</span> dct.items() <span class="keyword">if</span> <span class="keyword">not</span> name.startswith(<span class="string">&#x27;__&#x27;</span>)</span><br><span class="line">        uppercase_attr  = dict((name.upper(), value) <span class="keyword">for</span> name, value <span class="keyword">in</span> attrs)</span><br><span class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, uppercase_attr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Python3的用法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>(<span class="params">object, metaclass = UpperAttrMetaClass</span>):</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h2 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h2><h3 id="工厂方法"><a href="#工厂方法" class="headerlink" title="工厂方法"></a>工厂方法</h3><p>应用场景:具体的程序运行日志，网络日志，数据库日志等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Operation</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, num1=<span class="number">0</span>, num2=<span class="number">0</span></span>):</span></span><br><span class="line">        self.num1 = num1</span><br><span class="line">        self.num2 = num2</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parsed_data</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetSum</span>(<span class="params">Operation</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parsed_data</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&quot;num1+num2&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> self.num1 + self.num2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetReduce</span>(<span class="params">Operation</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parsed_data</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&quot;num1-num2&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> self.num1 - self.num2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工厂方法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choose_factory</span>(<span class="params">classname</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    工厂模式接口函数</span></span><br><span class="line"><span class="string">    :param classname:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    run = dict(GetReduce=GetReduce, GetSum=GetSum)</span><br><span class="line">    <span class="keyword">return</span> run[classname]()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    test1 = choose_factory(<span class="string">&#x27;GetSum&#x27;</span>)</span><br><span class="line">    test1.num1 = <span class="number">1</span></span><br><span class="line">    test1.num2 = <span class="number">3</span></span><br><span class="line">    test1.parsed_data()</span><br></pre></td></tr></table></figure>

<h3 id="抽象工厂"><a href="#抽象工厂" class="headerlink" title="抽象工厂"></a>抽象工厂</h3><p>应用场景：软件系统界面中不同主题下不同的按钮、文本框、字体</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mercedes</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;梅赛德斯&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Mercedes-Benz&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BMW</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;宝马&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;BMW&quot;</span></span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbstractFactory</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;抽象工厂&quot;&quot;&quot;</span></span><br><span class="line">    __metaclass__ = abc.ABCMeta</span><br><span class="line"></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">product_car</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MercedesFactory</span>(<span class="params">AbstractFactory</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;梅赛德斯工厂&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">product_car</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> Mercedes()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BMWFactory</span>(<span class="params">AbstractFactory</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;宝马工厂&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">product_car</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> BMW()</span><br><span class="line">c1 = MercedesFactory().product_car()</span><br><span class="line">c2 = BMWFactory().product_car()</span><br></pre></td></tr></table></figure>

<h2 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h2><p>理解：详细分析：在已打开回收站时，再打开一个新的回收站时，Windows系统并不会为你弹出一个新的回收站窗口，整个系统运行的过程中，系统只维护一个回收站的实例。<br>目的：每次执行类初始化返回的对象,内存地址都是相同的<br>场景：需要频繁实例化然后销毁的对象,方便资源相互通信的环境。<br>1、Python用以日志记录的logger就是一个单例模式<br>2、线程池，数据库连接池等资源池<br>3、配置文件读取<br>4、网站计数器</p>
<p><strong>优点：</strong></p>
<ul>
<li>在内存中只有一个对象，节省内存空间；</li>
<li>避免频繁地创建销毁对象，可以提高性能；</li>
<li>避免对共享资源的多重占用；</li>
<li>可以全局访问。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SinglethonType</span>(<span class="params">type</span>):</span></span><br><span class="line">    _instance_lock = threading.Lock()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">cls,*args,**kwargs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(cls,<span class="string">&quot;_instance&quot;</span>):</span><br><span class="line">            <span class="keyword">with</span> SingletonType._instance_lock:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> hasattr(cls,<span class="string">&quot;_instance&quot;</span>):</span><br><span class="line">                    cls._instance = super(SingethonType,cls).__call__(*args,**kwargs)</span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br></pre></td></tr></table></figure>

<p><strong>完整实例</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MusicPlayer</span>:</span></span><br><span class="line">    <span class="comment"># 记录第一个被创建对象的引用</span></span><br><span class="line">    instance = <span class="literal">None</span></span><br><span class="line">    <span class="comment"># 记录是否执行过初始化动作</span></span><br><span class="line">    init_flag = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        创建对象</span></span><br><span class="line"><span class="string">        :param args:</span></span><br><span class="line"><span class="string">        :param kwargs:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        print(<span class="string">&quot;创建对象 分配空间&quot;</span>)</span><br><span class="line">        <span class="comment"># 1.判断类属性是否为空对象</span></span><br><span class="line">        <span class="keyword">if</span> cls.instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 2.调用父类的方法，为第一个对象分配空间</span></span><br><span class="line">            cls.instance = super().__new__(cls)</span><br><span class="line">        <span class="comment"># 3.返回类属性保存的对象引用</span></span><br><span class="line">        <span class="keyword">return</span> cls.instance</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 默认的init方法是不可控的</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        播放器初始化</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 1、判断是否执行过初始化动作</span></span><br><span class="line">        <span class="keyword">if</span> MusicPlayer.init_flag:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># 2、执行初始化动作</span></span><br><span class="line">        print(<span class="string">&quot;播放器初始化&quot;</span>)</span><br><span class="line">        <span class="comment"># 3、修改类属性标记</span></span><br><span class="line">        MusicPlayer.init_flag = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_instance</span>(<span class="params">cls, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> cls.instance:</span><br><span class="line">            <span class="keyword">return</span> cls.instance</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            obj = cls(name)</span><br><span class="line">            cls.instance = obj</span><br><span class="line">            <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    player = MusicPlayer()</span><br><span class="line">    player2 = MusicPlayer()</span><br><span class="line">    <span class="comment"># 两次创建对象，结果返回的是同一个对象实例</span></span><br><span class="line">    print(player, player2)</span><br></pre></td></tr></table></figure>

<h2 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"></span><br><span class="line">Customer = namedtuple(<span class="string">&#x27;Customer&#x27;</span>, <span class="string">&#x27;name fidelity&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LineItem</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, product, quantity, price</span>):</span></span><br><span class="line">        self.product = product</span><br><span class="line">        self.quantity = quantity</span><br><span class="line">        self.price = price</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">total</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.price * self.quantity</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span>:</span>  <span class="comment"># the Context</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, customer, cart, promotion=None</span>):</span></span><br><span class="line">        self.customer = customer</span><br><span class="line">        self.cart = list(cart)</span><br><span class="line">        self.promotion = promotion</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">total</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">&#x27;__total&#x27;</span>):</span><br><span class="line">            self.__total = sum(item.total() <span class="keyword">for</span> item <span class="keyword">in</span> self.cart)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.__total</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">due</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.promotion <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            discount = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            discount = self.promotion(self)  <span class="comment"># &lt;1&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.total() - discount</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span>(<span class="params">self</span>):</span></span><br><span class="line">        fmt = <span class="string">&#x27;&lt;Order total: &#123;:.2f&#125; due: &#123;:.2f&#125;&gt;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> fmt.format(self.total(), self.due())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;2&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fidelity_promo</span>(<span class="params">order</span>):</span>  <span class="comment"># &lt;3&gt;</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;5% discount for customers with 1000 or more fidelity points&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> order.total() * <span class="number">.05</span> <span class="keyword">if</span> order.customer.fidelity &gt;= <span class="number">1000</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bulk_item_promo</span>(<span class="params">order</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;10% discount for each LineItem with 20 or more units&quot;&quot;&quot;</span></span><br><span class="line">    discount = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> order.cart:</span><br><span class="line">        <span class="keyword">if</span> item.quantity &gt;= <span class="number">20</span>:</span><br><span class="line">            discount += item.total() * <span class="number">.1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> discount</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">large_order_promo</span>(<span class="params">order</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;7% discount for orders with 10 or more distinct items&quot;&quot;&quot;</span></span><br><span class="line">    distinct_items = &#123;item.product <span class="keyword">for</span> item <span class="keyword">in</span> order.cart&#125;</span><br><span class="line">    <span class="keyword">if</span> len(distinct_items) &gt;= <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">return</span> order.total() * <span class="number">.07</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">promos = [fidelity_promo, bulk_item_promo, large_order_promo]  <span class="comment"># &lt;1&gt;promos 列出以函数实现的各个策略。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">best_promo</span>(<span class="params">order</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Select best discount available</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> max(promo(order) <span class="keyword">for</span> promo <span class="keyword">in</span> promos)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算折扣只需调用self.promotion()函数</span></span><br><span class="line"><span class="comment"># 没有抽象类 , 各个策略都是函数</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    joe = Customer(<span class="string">&#x27;John Doe&#x27;</span>, <span class="number">0.5</span>)</span><br><span class="line">    ann = Customer(<span class="string">&#x27;Ann Smith&#x27;</span>, <span class="number">1100</span>)</span><br><span class="line"></span><br><span class="line">    cart = [LineItem(<span class="string">&#x27;banana&#x27;</span>, <span class="number">4</span>, <span class="number">0.5</span>), LineItem(<span class="string">&#x27;apple&#x27;</span>, <span class="number">10</span>, <span class="number">1.5</span>), LineItem(<span class="string">&#x27;watermellon&#x27;</span>, <span class="number">5</span>, <span class="number">5.0</span>)]</span><br><span class="line">    print(Order(joe, cart, fidelity_promo))</span><br><span class="line">    print(Order(ann, cart, fidelity_promo))</span><br><span class="line"></span><br><span class="line">    banana_cart = [LineItem(<span class="string">&#x27;banana&#x27;</span>, <span class="number">30</span>, <span class="number">0.5</span>), LineItem(<span class="string">&#x27;apple&#x27;</span>, <span class="number">10</span>, <span class="number">1.5</span>)]</span><br><span class="line">    print(Order(joe, banana_cart, bulk_item_promo))</span><br><span class="line"></span><br><span class="line">    best_order = Order(ann, cart)</span><br><span class="line">    <span class="comment"># 返回折扣最大的</span></span><br><span class="line">    print(best_promo(best_order))</span><br><span class="line"></span><br><span class="line"><span class="comment"># import types</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># class People:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     def __init__(self, func=None):</span></span><br><span class="line"><span class="comment">#         if func:</span></span><br><span class="line"><span class="comment">#             # 动态绑定(模块方法在调用的时候自动传入被调用对象作为self参数)</span></span><br><span class="line"><span class="comment">#             self.speak = types.MethodType(func, self)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     def speak(self):</span></span><br><span class="line"><span class="comment">#         print(&quot;说中文&quot;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># def speak_english(self):</span></span><br><span class="line"><span class="comment">#     print(&#x27;说英语&#x27;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># def speak_german(self):</span></span><br><span class="line"><span class="comment">#     print(&#x27;说德语&#x27;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># if __name__ == &#x27;__main__&#x27;:</span></span><br><span class="line"><span class="comment">#     test1 = People()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     test2 = People(speak_english)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     test3 = People(speak_german)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     [func.speak() for func in [test1, test2, test3]]</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/09/Python%20%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Leo Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江湖の林九">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/09/Python%20%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8E%E5%A4%9A%E7%BA%BF%E7%A8%8B/" class="post-title-link" itemprop="url">Python 多进程与多线程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-09 11:00:05" itemprop="dateCreated datePublished" datetime="2019-11-09T11:00:05+08:00">2019-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-03 12:16:15" itemprop="dateModified" datetime="2020-05-03T12:16:15+08:00">2020-05-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%B6%B3%E8%BF%B9/" itemprop="url" rel="index"><span itemprop="name">编程足迹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><p>1、线程标识<br><code>threading.currentThread().ident</code><br>2、线程名<br><code>threading.currentThread().name</code><br>3、返回一个包含正在运行的线程的list<br><code>threading.enumerate()</code></p>
<h3 id="threading"><a href="#threading" class="headerlink" title="threading"></a>threading</h3><p>方式一：函数实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;thread worker function&quot;&quot;&quot;</span></span><br><span class="line">    print(<span class="string">&#x27;Worker: %s&#x27;</span> % num)</span><br><span class="line">	print(<span class="string">&quot;name:%s&quot;</span> % threading.current_thread().name)</span><br><span class="line">    print(<span class="string">&quot;ident:%s&quot;</span> % threading.current_thread().ident)</span><br><span class="line">    print(threading.enumerate())	</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    t = threading.Thread(target=worker, args=(i,))</span><br><span class="line">    threads.append(t)</span><br><span class="line">    t.start()</span><br></pre></td></tr></table></figure>
<p>方式二:继承threading.Thread，然后重写__init__方法和run方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span>(<span class="params">threading.Thread</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, thread_id</span>):</span></span><br><span class="line">        threading.Thread.__init__(self)</span><br><span class="line">        self.threadID = thread_id</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 把要执行的代码写到run函数里面,线程在创建后会直接运行run函数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.login()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line">            print(<span class="string">f&quot;<span class="subst">&#123;self.threadID&#125;</span> sleep 1s&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">        print(<span class="string">&quot;这是登陆函数&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="concurrent-futures-ThreadPoolExecutor"><a href="#concurrent-futures-ThreadPoolExecutor" class="headerlink" title="concurrent.futures.ThreadPoolExecutor"></a>concurrent.futures.ThreadPoolExecutor</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优点：主线程可以获取某一线程的状态或者某一任务的状态及返回值</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> concurrent.futures</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_html</span>(<span class="params">times, url</span>):</span></span><br><span class="line">    time.sleep(times)</span><br><span class="line">    print(<span class="string">&quot;&#123;&#125; get page &#123;&#125; Finished&quot;</span>.format(url, times))</span><br><span class="line">    <span class="keyword">return</span> times</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> executor:</span><br><span class="line">    <span class="comment"># 通过submit函数提交执行的函数到线程池中，submit非阻塞</span></span><br><span class="line">    task1 = executor.submit(get_html, <span class="number">3</span>, <span class="number">444</span>)</span><br><span class="line">    task2 = executor.submit(get_html, <span class="number">2</span>, <span class="number">555</span>)</span><br><span class="line"></span><br><span class="line">    print(task1.done())  <span class="comment"># done方法用于判定某个任务是否完成</span></span><br><span class="line">    print(task2.done())</span><br><span class="line">    <span class="comment"># 提交任务后立即判断任务状态，显示2个任务都未完成</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(task1.done())</span><br><span class="line">    print(task2.done())</span><br><span class="line"></span><br><span class="line">    print(task1.result())  <span class="comment"># result方法获取task的执行结果</span></span><br></pre></td></tr></table></figure>
<p>1、 wait(fs, timeout=None, return_when=ALL_COMPLETED)<br>wait 接受三个参数： fs: 表示需要执行的序列 timeout: 等待的最大时间，如果超过这个时间即使线程未执行完成也将返回 return_when：表示wait返回结果的条件，默认为 ALL_COMPLETED 全部执行完成再返回<br>2、as_completed<br>当子线程中的任务执行完后，直接用 result() 获取返回结果，在没有任务完成的时候，会一直阻塞，除非设置了 timeout。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">5</span>) <span class="keyword">as</span> t:</span><br><span class="line">	obj_list = []</span><br><span class="line">	<span class="keyword">for</span> page <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">		obj = t.submit(spider, page)</span><br><span class="line">		obj_list.append(obj)</span><br><span class="line">		</span><br><span class="line">	<span class="comment"># 先完成则先输出结果</span></span><br><span class="line">	<span class="keyword">for</span> future <span class="keyword">in</span> as_completed(obj_list):</span><br><span class="line">		data = future.result()</span><br><span class="line">		print(<span class="string">f&quot;main: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>3、map(fn, *iterables, timeout=None)<br>fn： 第一个参数 fn 是需要线程执行的函数；<br>iterables：第二个参数接受一个可迭代对象；<br>timeout： 第三个参数 timeout 跟 wait() 的 timeout 一样，但由于 map 是返回线程执行的结果，如果 timeout小于线程执行时间会抛异常 TimeoutError。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过executor获取已经完成的task，map返回结果的顺序和urls一致</span></span><br><span class="line"><span class="keyword">for</span> data <span class="keyword">in</span> executor.map(get_html, urls):</span><br><span class="line">	print(<span class="string">f&#x27;<span class="subst">&#123;data&#125;</span> ok&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="多线程什么时候需要加锁？"><a href="#多线程什么时候需要加锁？" class="headerlink" title="多线程什么时候需要加锁？"></a>多线程什么时候需要加锁？</h3><p>一般可能“同时发生多个写操作”或“同时发生读写操作”时，必需要加Lock，多人读则不必加锁。</p>
<h2 id="进程池"><a href="#进程池" class="headerlink" title="进程池"></a>进程池</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor">Process([<span class="params">group</span> [, <span class="params">target</span> [, <span class="params">name</span> [, <span class="params">args</span> [, <span class="params">kwargs</span>]]]]])</span></span><br><span class="line">- authkey</span><br><span class="line">- daemon：和线程的 setDeamon 功能一样（将父进程设置为守护进程，当父进程结束时，子进程也结束）。</span><br><span class="line">- exitcode(进程在运行时为 None、如果为 –N，表示被信号 N 结束）。</span><br><span class="line">- name：进程名字。</span><br><span class="line">- pid：进程号。</span><br></pre></td></tr></table></figure>
<h3 id="multiprocessing"><a href="#multiprocessing" class="headerlink" title="multiprocessing"></a>multiprocessing</h3><p>1、apply_async(func[, args=()[, kwds={}[, callback=None]]])</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool, cpu_count</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span>(<span class="params">msg</span>):</span></span><br><span class="line">    name = multiprocessing.current_process().name</span><br><span class="line">    print(<span class="string">f&quot;process name:<span class="subst">&#123;name&#125;</span>&quot;</span>)</span><br><span class="line">    t_start = time.time()</span><br><span class="line">    print(<span class="string">&quot;%s开始执行,进程号为%d&quot;</span> % (msg, os.getpid()))</span><br><span class="line">    time.sleep(random.random() * <span class="number">2</span>)</span><br><span class="line">    t_stop = time.time()</span><br><span class="line">    print(msg, <span class="string">&quot;执行完毕,耗时%0.2f&quot;</span> % (t_stop - t_start))</span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># cpu_count()获取核数</span></span><br><span class="line">    process_pool = Pool(cpu_count())</span><br><span class="line"></span><br><span class="line">    results = []</span><br><span class="line">    <span class="comment"># 每次循环会用空闲出来的子进程去调用目标</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">        result = process_pool.apply_async(worker, (i,))</span><br><span class="line">        results.append(result)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;--start--&quot;</span>)</span><br><span class="line">    <span class="comment"># 关闭进程池后不再接收新的任务</span></span><br><span class="line">    process_pool.close()</span><br><span class="line">    <span class="comment"># join必须放在close语句后,主进程阻塞等待子进程的退出</span></span><br><span class="line">    process_pool.join()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># apply_async后get()是阻塞执行的</span></span><br><span class="line">    <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">        print(result.get())</span><br><span class="line">    print(<span class="string">&quot;---end---&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2、map(func, iterable[, chunksize=None])用法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pool_outputs = pool.map(do_calculation, inputs)</span><br><span class="line">pool.close()  <span class="comment"># no more tasks</span></span><br><span class="line">pool.join()  <span class="comment"># wrap up current tasks</span></span><br></pre></td></tr></table></figure>

<h3 id="concurrent-futures-ProcessPoolExecutor"><a href="#concurrent-futures-ProcessPoolExecutor" class="headerlink" title="concurrent.futures.ProcessPoolExecutor"></a>concurrent.futures.ProcessPoolExecutor</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 虽然内部千差万别，但外部的api接口都一样</span></span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">return_future_result</span>(<span class="params">message</span>):</span></span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">return</span> message</span><br><span class="line">pool = ProcessPoolExecutor(max_workers=<span class="number">2</span>)</span><br><span class="line">future1 = pool.submit(return_future_result, (<span class="string">&quot;hello&quot;</span>))</span><br><span class="line">future2 = pool.submit(return_future_result, (<span class="string">&quot;world&quot;</span>))</span><br><span class="line">print(future1.done())</span><br><span class="line">time.sleep(<span class="number">11</span>)</span><br><span class="line">print(future2.done())</span><br><span class="line">print(future1.result())</span><br><span class="line">print(future2.result())</span><br></pre></td></tr></table></figure>

<h3 id="守护进程"><a href="#守护进程" class="headerlink" title="守护进程"></a>守护进程</h3><p>默认情况下，在所有子进程退出之前，主程序不会退出。<br>有些时候，启动后台进程运行而不阻止主程序退出是有用的，例如为监视工具生成“心跳”的任务。<br>要将进程标记为守护程序很简单，只要将daemon属性设置为 True 就可以了。</p>
<h2 id="通信、同步与数据共享"><a href="#通信、同步与数据共享" class="headerlink" title="通信、同步与数据共享"></a>通信、同步与数据共享</h2><h3 id="互斥锁，控制对资源的访问"><a href="#互斥锁，控制对资源的访问" class="headerlink" title="互斥锁，控制对资源的访问"></a>互斥锁，控制对资源的访问</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建互斥锁，加锁会影响程序性能，锁住的代码越少越好</span></span><br><span class="line">mutex = threading.Lock()</span><br><span class="line"><span class="comment">#锁定</span></span><br><span class="line">mutex.acquire([timeout])</span><br><span class="line"><span class="comment">#释放</span></span><br><span class="line">mutex.release()</span><br></pre></td></tr></table></figure>
<p><strong>死锁</strong>：在线程间共享多个资源的时候，如果两个线程分别占有一部分资源并且同时等待对方的资源，就会造成死锁。</p>
<h3 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h3><p>多进程的队列应使用from multiprocessing import Queue。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_detail_html</span>(<span class="params">queue</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    爬取文章详情页</span></span><br><span class="line"><span class="string">    :param queue:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        url = queue.get()</span><br><span class="line">        print(<span class="string">&quot;get detail html started&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        print(<span class="string">&quot;get detail html end&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_detail_url</span>(<span class="params">queue</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    爬取文章列表页</span></span><br><span class="line"><span class="string">    :param queue:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        print(<span class="string">&quot;get detail url started&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">            queue.put(<span class="string">&quot;http://projectsedu.com/&#123;id&#125;&quot;</span>.format(id=i))</span><br><span class="line">        print(<span class="string">&quot;get detail url end&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    detail_url_queue = Queue(maxsize=<span class="number">1000</span>)</span><br><span class="line">	.....</span><br></pre></td></tr></table></figure>

<h3 id="条件对象，复杂同步操作"><a href="#条件对象，复杂同步操作" class="headerlink" title="条件对象，复杂同步操作"></a>条件对象，复杂同步操作</h3><ul>
<li>基本原理：<br>可以认为Condition对象维护了一个锁（Lock/RLock)和一个waiting池。<br>Condition自身提供了wait/notify/notifyAll方法，用于阻塞/通知其他并行线程。<br>条件变量服从 上下文管理协议：使用 with 语句会在它包围的代码块内获取关联的锁。<br>acquire() 和 release() 方法也能调用关联锁的相关方法。</li>
<li>方法：<br>acquire(*args)：获取锁。这个方法调用底层锁的相应方法。<br>release()：释放锁。这个方法调用底层锁的相应方法。<br>wait(timeout=None)：线程挂起(阻塞状态)，等待直到被通知或发生超时。如果线程在调用此方法时没有获得锁，将会引发 RuntimeError 异常。这个方法释放底层锁，然后阻塞，直到在另外一个线程中调用同一个条件变量的 notify() 或 notify_all() 唤醒它，或者直到可选的超时发生。一旦被唤醒或者超时，它重新获得锁并返回。<br>wait_for(predicate, timeout=None)：等待，直到条件计算为真。等价于如下：<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">while</span></span> <span class="variable"><span class="keyword">not</span></span> <span class="function"><span class="title">predicate</span>():</span></span><br><span class="line"><span class="function">    <span class="variable">cv.wait</span>()</span></span><br></pre></td></tr></table></figure>
notify(n=1)：唤醒一个等待这个条件的线程，那些挂起的线程接到这个通知之后会开始运行。<br>notify_all()：唤醒所有正在等待这个条件的线程。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Xiao</span>(<span class="params">threading.Thread</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,cond</span>):</span></span><br><span class="line">		super().__init__(name=<span class="string">&quot;测试&quot;</span>)</span><br><span class="line">		self.cond = cond</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">with</span> self.cond:</span><br><span class="line">			self.cond.wait()</span><br><span class="line">			print(<span class="string">&quot;hi是测试&quot;</span>)</span><br><span class="line">			self.cond.notify() </span><br><span class="line">	</span><br><span class="line">condition = threading.Condition()</span><br><span class="line">xiao = Xiao(cond)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Condition的生产者消费者模式"><a href="#Condition的生产者消费者模式" class="headerlink" title="Condition的生产者消费者模式"></a>Condition的生产者消费者模式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建条件变量condition</span></span><br><span class="line">con = threading.Condition()</span><br><span class="line">meat_num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">thread_consumers</span>():</span></span><br><span class="line">    <span class="comment"># 条件变量condition 线程上锁</span></span><br><span class="line">    con.acquire()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 全局变量声明关键字 global</span></span><br><span class="line">    <span class="keyword">global</span> meat_num</span><br><span class="line">    meat_num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待肉片下锅煮熟</span></span><br><span class="line">    con.wait()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        print(<span class="string">&quot;我来一块肉片...&quot;</span>)</span><br><span class="line">        meat_num -= <span class="number">1</span></span><br><span class="line">        print(<span class="string">&quot;剩余肉片数量：%d&quot;</span> % meat_num)</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        <span class="keyword">if</span> meat_num == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 肉片吃光了，通知老板添加肉片</span></span><br><span class="line">            print(<span class="string">&quot;老板，再来一份老肉片...&quot;</span>)</span><br><span class="line">            con.notify()</span><br><span class="line">            <span class="comment"># 肉片吃光了，等待肉片</span></span><br><span class="line">            con.wait()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 条件变量condition 线程释放锁</span></span><br><span class="line">    con.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">thread_producer</span>():</span></span><br><span class="line">    <span class="comment"># 条件变量condition 线程上锁</span></span><br><span class="line">    con.acquire()</span><br><span class="line">    <span class="comment"># 全局变量声明关键字 global</span></span><br><span class="line">    <span class="keyword">global</span> meat_num</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 肉片熟了，可以开始吃了</span></span><br><span class="line">    meat_num = <span class="number">10</span></span><br><span class="line">    print(<span class="string">&quot;肉片熟了，可以开始吃了...&quot;</span>)</span><br><span class="line">    con.notify()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># 阻塞函数,等待肉片吃完的通知</span></span><br><span class="line">        con.wait()</span><br><span class="line">        meat_num = <span class="number">10</span></span><br><span class="line">        <span class="comment"># 添加肉片完成，可以继续开吃</span></span><br><span class="line">        print(<span class="string">&quot;添加肉片成功！当前肉片数量：%d&quot;</span> % meat_num)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        con.notify()</span><br><span class="line"></span><br><span class="line">    con.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 创建并初始化线程</span></span><br><span class="line">    t1 = threading.Thread(target=thread_producer)</span><br><span class="line">    t2 = threading.Thread(target=thread_consumers)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 启动线程 -- 注意线程启动顺序，启动顺序很重要</span></span><br><span class="line">    t2.start()</span><br><span class="line">    t1.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 阻塞主线程，等待子线程结束</span></span><br><span class="line">    t1.join()</span><br><span class="line">    t2.join()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">&quot;程序结束！&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>简单理解：假如线程1需要数据，那么线程1就阻塞等待，这时线程2就去制造数据，线程2制造好数据后，通知线程1可以去取数据了，然后线程1去获取数据。</p>
<h3 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h3><p>1、控制对资源的并发访问，用于保护数量有限的资源，例如数据库服务。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">s1 = threading.Semaphore(<span class="number">5</span>)  <span class="comment"># 添加一个计数器</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>():</span></span><br><span class="line">    s1.acquire()  <span class="comment"># 计数器获得锁</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)  <span class="comment"># 程序休眠2秒</span></span><br><span class="line">    print(<span class="string">&quot;ok&quot;</span>, time.ctime())</span><br><span class="line">    s1.release()  <span class="comment"># 计数器释放锁</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">    t1 = threading.Thread(target=foo, args=())  <span class="comment"># 创建线程</span></span><br><span class="line">    t1.start()  <span class="comment"># 启动线程</span></span><br></pre></td></tr></table></figure>
<p>2、信号量PV操作<br>具体定义如下：<br>    P（S）：①将信号量S的值减1，即S=S-1；<br>           ②如果S&gt;=0，则该进程继续执行；否则该进程置为等待状态，排入等待队列。<br>    V（S）：①将信号量S的值加1，即S=S+1；<br>           ②如果S&gt;0，则该进程继续执行；否则释放队列中第一个等待信号量的进程。<br>所以：信号量S&gt;=0时，S表示可用资源的数量。当S&lt;0时，表示已经没有可用资源，S的绝对值表示当前等待该资源的进程数。</p>
<p>其中信号量S用于互斥，初值为1。<br>使用PV操作实现进程互斥时应该注意的是：<br>（1）每个程序中用户实现互斥的P、V操作必须成对出现，先做P操作，进临界区，后做V操作，出临界区。若有多个分支，要认真检查其成对性。<br>（2）P、V操作应分别紧靠临界区的头尾部，临界区的代码应尽可能短，不能有死循环。<br>（3）互斥信号量的初值一般为1。<br>使用PV操作实现进程同步时应该注意的是：<br>（1）分析进程间的制约关系，确定信号量种类。在保持进程间有正确的同步关系情况下，哪个进程先执行，哪些进程后执行，彼此间通过什么资源（信号量）进行协调，从而明确要设置哪些信号量。<br>（2）信号量的初值与相应资源的数量有关，也与P、V操作在程序代码中出现的位置有关。<br>（3）同一信号量的P、V操作要成对出现，但它们分别在不同的进程代码中。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">import threading</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">lock_1 = threading.Semaphore(1)  # 检查售票员是否关门</span><br><span class="line">lock_2 = threading.Semaphore(0)  # 检查司机是否停车</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def driver():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(3):</span><br><span class="line">        lock_1.acquire()</span><br><span class="line">        <span class="builtin-name">print</span>(<span class="string">&#x27;司机开车&#x27;</span>)</span><br><span class="line">        time.sleep(1)</span><br><span class="line">        <span class="builtin-name">print</span>(<span class="string">&#x27;驾驶&#x27;</span>)</span><br><span class="line">        <span class="builtin-name">print</span>(<span class="string">&#x27;到站停车&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        lock_2.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def passenger():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(3):</span><br><span class="line">        lock_2.acquire()</span><br><span class="line">        time.sleep(1)</span><br><span class="line">        <span class="builtin-name">print</span>(<span class="string">&#x27;打开车门&#x27;</span>)</span><br><span class="line">        <span class="builtin-name">print</span>(<span class="string">&#x27;乘客上下车&#x27;</span>)</span><br><span class="line">        time.sleep(1)</span><br><span class="line">        <span class="builtin-name">print</span>(<span class="string">&#x27;关上车门&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    p1 = threading.Thread(<span class="attribute">target</span>=driver)</span><br><span class="line">    p2 = threading.Thread(<span class="attribute">target</span>=passenger)</span><br><span class="line">    p1.start()</span><br><span class="line">    p2.start()</span><br><span class="line">    p1.join()</span><br><span class="line">    p2.join()</span><br></pre></td></tr></table></figure>
<p>每当调用acquire()时内置计数器-1；调用release() 时内置计数器+1；<br>计数器不能小于0；当计数器为0时，acquire()将阻塞线程直到其他线程调用release()。将lock_1的初值赋为1，lock_2的初值赋为0，则先执行司机这一线程。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/08/Python%20%E7%94%9F%E6%88%90%E5%99%A8%E4%B8%8E%E8%A3%85%E9%A5%B0%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Leo Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江湖の林九">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/08/Python%20%E7%94%9F%E6%88%90%E5%99%A8%E4%B8%8E%E8%A3%85%E9%A5%B0%E5%99%A8/" class="post-title-link" itemprop="url">Python 生成器与装饰器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-08 12:00:00" itemprop="dateCreated datePublished" datetime="2019-11-08T12:00:00+08:00">2019-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-24 10:15:02" itemprop="dateModified" datetime="2020-04-24T10:15:02+08:00">2020-04-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%B6%B3%E8%BF%B9/" itemprop="url" rel="index"><span itemprop="name">编程足迹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="基础内容"><a href="#基础内容" class="headerlink" title="基础内容"></a>基础内容</h2><p>演示网址：<a target="_blank" rel="noopener" href="http://www.pythontutor.com/visualize.html#mode=edit">http://www.pythontutor.com/visualize.html#mode=edit</a><br>1、可变对象：list、dict、set<br>2、不可变对象：tuple、string、int、float、bool、bytes、frozen set</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: a = <span class="number">7</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: b = <span class="number">7</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">3</span>]: id(a)</span><br><span class="line">Out[<span class="number">3</span>]: <span class="number">1641525664</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]: id(b)</span><br><span class="line">Out[<span class="number">4</span>]: <span class="number">1641525664</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: a = <span class="number">8</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">6</span>]: id(a)</span><br><span class="line">Out[<span class="number">6</span>]: <span class="number">1641525696</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">7</span>]: a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: id(a)</span><br><span class="line">Out[<span class="number">8</span>]: <span class="number">1474053257352</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">9</span>]: a[<span class="number">0</span>] = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">10</span>]: id(a)</span><br><span class="line">Out[<span class="number">10</span>]: <span class="number">1474053257352</span></span><br></pre></td></tr></table></figure>
<p>特点：</p>
<ul>
<li>显然可以看到可变对象修改后，地址是没有改变的，而不可变对象每一次操作就重建新对象。</li>
<li>全局可变对象，操作不会重建对象,可以通过dict[‘x’]=y或list.append()之类的来修改跟创建变量不冲突，所以都不用显式global声明。</li>
<li>不可变对象指的是元素指向永远不变，因此形如data=(1,2,[3,4])可修改列表内的元素。</li>
</ul>
<h2 id="深浅拷贝"><a href="#深浅拷贝" class="headerlink" title="深浅拷贝"></a>深浅拷贝</h2><p>1、浅拷贝：拷贝父对象，但内部子对象还是引用<br>2、深拷贝：完全拷贝了父对象及其子对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">Anndy = [<span class="number">1</span>, <span class="string">&#x27;Anndy&#x27;</span>, [<span class="string">&#x27;age&#x27;</span>, <span class="number">24</span>, [<span class="number">1</span>, <span class="number">2</span>]], (<span class="number">3</span>, <span class="number">4</span>)]</span><br><span class="line">Tom = copy.deepcopy(Anndy)</span><br><span class="line">Bob = copy.copy(Anndy)</span><br></pre></td></tr></table></figure>
<p><img src="/images/12-PythonOther/3-basic.png"></p>
<p>1、dis简单分析<br>指令结构：源码行号 | 指令在函数中的偏移 | 指令符号 | 指令参数 | 实际参数值<br><code>load_const</code>: Pushes co_consts[consti] onto the stack.<br><code>store_name</code>: 参数，co_names[0]=TOS，出栈同时将栈顶赋值给i<br><code>setup_loop</code>: 循环代码块入栈,(to 26)可理解为当前指令到26索引前的为循环块<br><code>RETURN_VALUE</code>: Returns with TOS to the caller of the function</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">5           4 LOAD_CONST               1 (0)</span><br><span class="line">            6 LOAD_CONST               2 (None)</span><br><span class="line">            8 IMPORT_NAME              1 (copy)</span><br><span class="line">           10 STORE_NAME               1 (copy)</span><br><span class="line"></span><br><span class="line">7          12 LOAD_CONST               3 (1)</span><br><span class="line">           14 LOAD_CONST               4 (&#x27;Anndy&#x27;)</span><br><span class="line">           16 LOAD_CONST               5 (&#x27;age&#x27;)</span><br><span class="line">           18 LOAD_CONST               6 (24)</span><br><span class="line">           20 LOAD_CONST               3 (1)</span><br><span class="line">           22 LOAD_CONST               7 (2)</span><br><span class="line">           24 BUILD_LIST               2</span><br><span class="line">           26 BUILD_LIST               3</span><br><span class="line">           28 LOAD_CONST              10 ((3, 4))</span><br><span class="line">           30 BUILD_LIST               4</span><br><span class="line">           32 STORE_NAME               2 (Anndy)</span><br><span class="line"></span><br><span class="line">8          34 LOAD_NAME                1 (copy)</span><br><span class="line">           36 LOAD_ATTR                3 (deepcopy)</span><br><span class="line">           38 LOAD_NAME                2 (Anndy)</span><br><span class="line">           40 CALL_FUNCTION            1</span><br><span class="line">           42 STORE_NAME               4 (Tom)</span><br><span class="line"></span><br><span class="line">9          44 LOAD_NAME                1 (copy)</span><br><span class="line">           46 LOAD_ATTR                1 (copy)</span><br><span class="line">           48 LOAD_NAME                2 (Anndy)</span><br><span class="line">           50 CALL_FUNCTION            1</span><br><span class="line">           52 STORE_NAME               5 (Bob)</span><br><span class="line">           54 LOAD_CONST               2 (None)</span><br><span class="line">           56 RETURN_VALUE</span><br></pre></td></tr></table></figure>

<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><h3 id="判断可迭代对象"><a href="#判断可迭代对象" class="headerlink" title="判断可迭代对象"></a>判断可迭代对象</h3><ul>
<li>isinstance(l,Iterable)</li>
<li>assert ‘<em>iter</em>‘ in dir([])</li>
</ul>
<h3 id="自定义-iter-和-next-实现迭代器"><a href="#自定义-iter-和-next-实现迭代器" class="headerlink" title="自定义__iter__和__next__实现迭代器"></a>自定义__iter__和__next__实现迭代器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IterA</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,num</span>):</span></span><br><span class="line">		self.num = num</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__iter__</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">return</span> self</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__next__</span>(<span class="params">self</span>):</span></span><br><span class="line">		self.num += <span class="number">1</span></span><br><span class="line">		<span class="keyword">return</span> self.num</span><br></pre></td></tr></table></figure>

<h3 id="模拟实现for循环行为"><a href="#模拟实现for循环行为" class="headerlink" title="模拟实现for循环行为"></a>模拟实现for循环行为</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mylist = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">mylist_iter = mylist.__iter__()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		item = mylist_iter.__next__()</span><br><span class="line">		print(item)</span><br><span class="line">	<span class="keyword">except</span> StopIteration:</span><br><span class="line">		<span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h2 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h2><h3 id="生成器函数"><a href="#生成器函数" class="headerlink" title="生成器函数"></a>生成器函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fib</span>(<span class="params">end = <span class="number">1000</span></span>):</span></span><br><span class="line">    prev,curr=<span class="number">0</span>,<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> curr &lt; end:</span><br><span class="line">        <span class="keyword">yield</span> curr</span><br><span class="line">        prev,curr=curr,curr+prev</span><br></pre></td></tr></table></figure>

<h3 id="生成器表达式"><a href="#生成器表达式" class="headerlink" title="生成器表达式"></a>生成器表达式</h3><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g = (<span class="name">x*2</span> for x in range(<span class="number">10</span>))</span><br></pre></td></tr></table></figure>

<h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><p>闭包是由函数和与其相关的引用环境组合而成的实体，将函数与其所操作的某些数据关联起来。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">outer</span>(<span class="params">n</span>):</span></span><br><span class="line">	count = <span class="number">0</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">inner</span>():</span></span><br><span class="line">	<span class="comment"># 需要改写外部变量时,声明nonlocal会优先寻找层级关系与闭包作用域最近的外部变量</span></span><br><span class="line">		<span class="keyword">nonlocal</span> count</span><br><span class="line">		count  = <span class="number">2</span></span><br><span class="line">		print(n+count)</span><br><span class="line">	print(inner.__closure__)</span><br><span class="line">	<span class="comment"># 自由变量存储在闭包的 cell_contents中</span></span><br><span class="line">	print(inner.__closure__[<span class="number">0</span>].cell_contents)</span><br><span class="line">	<span class="keyword">return</span> inner</span><br></pre></td></tr></table></figure>

<h3 id="用生成器实现协程"><a href="#用生成器实现协程" class="headerlink" title="用生成器实现协程"></a>用生成器实现协程</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> inspect <span class="keyword">import</span> getgeneratorstate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子生成器</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">average_gen</span>():</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    average = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        new_num = <span class="keyword">yield</span> average</span><br><span class="line">        <span class="keyword">if</span> new_num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        total += new_num</span><br><span class="line">        average = total / count</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 每一次return，都意味着当前协程结束。</span></span><br><span class="line">    <span class="keyword">return</span> total, count, average</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 委托生成器负责委托子生成器完成具体任务,借助yield from传递给子生成器中yield</span></span><br><span class="line"><span class="comment"># 第一次对委派生成器调用next()或.send(None)时，会执行到第一个yield from表达式并暂停。</span></span><br><span class="line"><span class="comment"># 当继续调用委派生成器的.send()，.throw()和.close()等方法时，会“直接”作用到最内层的子生成器上，而不是让委派生成器的代码继续向前执行。</span></span><br><span class="line"><span class="comment"># 只有当子生成器抛出StopIteration异常后，委派生成器中的代码才继续执行，并将StopIteration.value的值作为yield from表达式的返回值。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">proxy_gen</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># 只有子生成器要结束（return）了，yield from左边的变量才会被赋值，后面的代码才会执行。</span></span><br><span class="line">        total, count, average = <span class="keyword">yield</span> <span class="keyword">from</span> average_gen()</span><br><span class="line">        print(<span class="string">&quot;计算完毕！！\n总共传入 &#123;&#125; 个数值， 总和：&#123;&#125;，平均数：&#123;&#125;&quot;</span>.format(count, total, average))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用方</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    calc_average = proxy_gen()</span><br><span class="line">    next(calc_average)  <span class="comment"># 预激协程</span></span><br><span class="line">    print(calc_average.send(<span class="number">10</span>))  <span class="comment"># 打印：10.0,即子生成器yield的值</span></span><br><span class="line">    print(calc_average.send(<span class="number">20</span>))  <span class="comment"># 打印：15.0</span></span><br><span class="line">    print(getgeneratorstate(calc_average))  <span class="comment"># 打印协程所处的状态</span></span><br><span class="line">    print(calc_average.send(<span class="number">30</span>))  <span class="comment"># 打印：20.0</span></span><br><span class="line">    calc_average.send(<span class="literal">None</span>)  <span class="comment"># 结束协程</span></span><br><span class="line">    <span class="comment"># 如果此处再调用calc_average.send(10)，由于上一协程已经结束，将重开一协程</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h2><p>作用：不破坏原有结构的前提下,为已经存在的对象添加额外的功能,提高程序可重复利用性，增加程序可读性。<br>场景：用于有切面需求的场景，比如：插入日志、性能测试、事务处理、缓存、权限校验等。<br>特性：通常装饰器定义在一个模块中，然后应用到其他模块中的函数上，装饰函数通常在加载模块时立即运行，被装饰的函数只在明确调用时运行。</p>
<h3 id="带参装饰器"><a href="#带参装饰器" class="headerlink" title="带参装饰器"></a>带参装饰器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_param</span>(<span class="params">paragram</span>):</span></span><br><span class="line">    print(<span class="string">&quot;start...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">        @wraps(func)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">            <span class="keyword">if</span> paragram == <span class="number">1</span>:</span><br><span class="line">                print(<span class="string">&#x27;在被装饰的函数执行之前做的事&#x27;</span>)</span><br><span class="line">            ret = func(*args, **kwargs)</span><br><span class="line">            print(<span class="string">&#x27;在被装饰的函数执行之后做的事&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> inner</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对原有装饰器封装返回一个装饰器，调用时能把参数传递到装饰器的环境中。</span></span><br><span class="line"><span class="comment"># 实际上先执行了add_param(123)，返回了绑定paragram的wrapper装饰器,再装饰目标函数</span></span><br><span class="line"><span class="meta">@add_param(123)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destination</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    学习装饰器</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    print(<span class="string">&quot;目标函数！&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">destination()</span><br><span class="line">print(destination.__doc__)</span><br></pre></td></tr></table></figure>

<h3 id="多层装饰器"><a href="#多层装饰器" class="headerlink" title="多层装饰器"></a>多层装饰器</h3><p>即外层装饰器会对内层装饰器装饰的结果进行再装饰，等价于test = set_fun2(set_fun1(test))。</p>
<h3 id="类装饰器"><a href="#类装饰器" class="headerlink" title="类装饰器"></a>类装饰器</h3><p>类装饰器可以依靠类内部的 __call__方法，当使用 @ 形式将装饰器附加到函数上时就会调用此方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, func</span>):</span></span><br><span class="line">        self._func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">print</span> (<span class="string">&#x27;class decorator runing&#x27;</span>)</span><br><span class="line">        self._func()</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">&#x27;class decorator ending&#x27;</span>)</span><br><span class="line"><span class="meta">@Foo</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span>():</span></span><br><span class="line">    <span class="keyword">print</span> (<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line">bar()</span><br></pre></td></tr></table></figure>

<h3 id="第三方包写装饰器"><a href="#第三方包写装饰器" class="headerlink" title="第三方包写装饰器"></a>第三方包写装饰器</h3><p>1、函数签名是固定的，必须是(wrapped, instance, args, kwargs)，注意第二个参数instance是必须的。<br>2、args和kwargs也是固定的，注意前面没有星号，<strong>在装饰器内部调用原函数时才带星号</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> wrapt</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@wrapt.decorator</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pass_through</span>(<span class="params">wrapped, instance, args, kwargs</span>):</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    wrapped(*args, **kwargs)</span><br><span class="line">    print(time.time() - start)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@pass_through</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">function</span>():</span></span><br><span class="line">    print(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function()</span><br></pre></td></tr></table></figure>

<h2 id="默认参数陷阱"><a href="#默认参数陷阱" class="headerlink" title="默认参数陷阱"></a>默认参数陷阱</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">numbers=[], num=<span class="number">1</span></span>):</span></span><br><span class="line"><span class="meta">... </span>    numbers.append(num)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> numbers</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func()</span><br><span class="line">[<span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func()</span><br><span class="line">[<span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func()</span><br><span class="line">[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<p>解释：在 Python 中，函数是第一类对象(function is the first class object)，初始化完成时，属性 <strong>default</strong> 中的第一个默认参数 numbers 指向一个空列表。<br>如何避免前面那种情况发生呢？就是不要用可变对象作为参数的默认值。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/08/Python%20%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%20%E5%8F%82%E6%95%B0%20%E6%96%AD%E8%A8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Leo Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江湖の林九">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/08/Python%20%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%20%E5%8F%82%E6%95%B0%20%E6%96%AD%E8%A8%80/" class="post-title-link" itemprop="url">Python 字符编码 参数 断言</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-08 10:00:00" itemprop="dateCreated datePublished" datetime="2019-11-08T10:00:00+08:00">2019-11-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-24 10:10:48" itemprop="dateModified" datetime="2020-04-24T10:10:48+08:00">2020-04-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%B6%B3%E8%BF%B9/" itemprop="url" rel="index"><span itemprop="name">编程足迹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h2><p>assert是用来检查一个条件，如果它为真，就不做任何事。如果它为假，则会抛出AssertError和错误信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assert</span> 表达式 [, 参数]</span><br><span class="line"><span class="keyword">assert</span> len(lists) &gt;=<span class="number">5</span>,<span class="string">&#x27;列表元素个数小于5&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="字符编码"><a href="#字符编码" class="headerlink" title="字符编码"></a>字符编码</h2><p>1、ASCII<br>大小写英文字母，特殊字符，数字，早期ASCII 字符编码规定使用单字节中低位的7个比特去编码所有的字符（\x80以下），ASCII 扩充字符集利用了后128个字符。</p>
<p>2、Unicode（”\u”表示Unicode编码）<br>Unicode 标准使用十六进制数字表示（UCS-2和UCS-4），UCS-4用4个字节（实际上只用了31位，最高位必须为0）。<br>局限性：对于一个字节可以表示的字符用2个字节浪费空间。</p>
<p>3、UTF-8/UTF-16<br>UTF-8作为Unicode的一种实现形式，一个字符最少用8位去表示，属于变长的字符编码。<br>英文字符1字节，欧文字符2字节，中文3字节，生僻汉字4-6字节。</p>
<p>4、GBK/GB2312/ANSI<br>GB2312中国人设计的双字节编码，后在GB2312的基础上创建了GBK 编码，GBK 收录了27484个汉字兼容 ASCII 编码，对于英文字符用1个字节来表示，汉字用两个字节来标识。<br>不同的国家和地区制定了不同的标准，由此产生了 GB2312、GBK、GB18030、Big5、Shift_JIS 等各自的编码标准,这些使用多个字节来代表一个字符的各种汉字延伸编码方式，称为 ANSI 编码。<br>在简体中文Windows操作系统中ANSI 编码代表 GBK 编码，不同 ANSI 编码之间互不兼容，当信息在国际间交流时，无法将属于两种语言的文字，存储在同一段 ANSI 编码的文本中【百度百科】。<br><img src="/images/12-PythonOther/2-encode.png"></p>
<p>5、从bytes 到另一编码的 bytes 必须先 decode 后才能 encode。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&quot;中文&quot;</span>.encode(<span class="string">&quot;unicode-escape&quot;</span>) <span class="comment"># Python3下获得&#x27;中文&#x27;的Unicode编码</span></span><br><span class="line"><span class="string">b&#x27;\\u4e2d\\u6587&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>1、关键字参数：传入0个或任意个含参数名的参数,在函数内部自动组装为一个dict即*<em>kwargs。<br>2、位置参数：按照位置顺序,给函数传递参数。<br>3、默认参数：给参数传默认的值,默认参数一定要指向不变对象。<br>4、可选参数：传入的参数个数是可变的即</em>args形式。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;args=&#x27;</span>, args)</span><br><span class="line">    print(<span class="string">&#x27;kwargs=&#x27;</span>, kwargs)</span><br><span class="line">    print(<span class="string">&#x27;**********************&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    foo(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    foo(a=<span class="number">1</span>, b=<span class="number">2</span>, c=<span class="number">3</span>)</span><br><span class="line">    foo(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, a=<span class="number">1</span>, b=<span class="number">2</span>, c=<span class="number">3</span>)</span><br><span class="line">    foo(<span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, a=<span class="number">1</span>, b=<span class="string">&#x27;b&#x27;</span>, c=<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">    <span class="comment"># 星号*把序列/集合解包（unpack）成位置参数，两个星号**把字典解包成关键字参数。</span></span><br><span class="line">    dict = &#123;name:<span class="number">1</span>,sex:<span class="number">2</span>&#125;</span><br><span class="line">    foo(<span class="number">66</span>,**dict)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">args= (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">kwargs= &#123;&#125;</span><br><span class="line">**********************</span><br><span class="line">args= ()</span><br><span class="line">kwargs= &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;c&#x27;</span>: <span class="number">3</span>&#125;</span><br><span class="line">**********************</span><br><span class="line">args= (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">kwargs= &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;c&#x27;</span>: <span class="number">3</span>&#125;</span><br><span class="line">**********************</span><br><span class="line">args= (<span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">kwargs= &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>: <span class="string">&#x27;c&#x27;</span>&#125;</span><br><span class="line">**********************</span><br><span class="line">args= (<span class="number">66</span>,)</span><br><span class="line">kwargs= &#123;<span class="string">&#x27;name&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;sex&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">**********************</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/05/Python%20%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Leo Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江湖の林九">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/05/Python%20%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">Python 排序算法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-05 17:24:00" itemprop="dateCreated datePublished" datetime="2019-11-05T17:24:00+08:00">2019-11-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-24 10:04:13" itemprop="dateModified" datetime="2020-04-24T10:04:13+08:00">2020-04-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%B6%B3%E8%BF%B9/" itemprop="url" rel="index"><span itemprop="name">编程足迹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、冒泡排序"><a href="#一、冒泡排序" class="headerlink" title="一、冒泡排序"></a>一、冒泡排序</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bububle_sort</span>(<span class="params">alist</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;冒泡排序(稳定|n^2m)&quot;&quot;&quot;</span></span><br><span class="line">    n = len(alist)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(n<span class="number">-1</span>):</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,n<span class="number">-1</span>-j):</span><br><span class="line">            <span class="keyword">if</span> alist[i]&gt;alist[i+<span class="number">1</span>]:</span><br><span class="line">                count +=<span class="number">1</span></span><br><span class="line">                alist[i], alist[i+<span class="number">1</span>] = alist[i+<span class="number">1</span>], alist[i]</span><br><span class="line">        <span class="keyword">if</span> count==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<h2 id="二、选择排序"><a href="#二、选择排序" class="headerlink" title="二、选择排序"></a>二、选择排序</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_sort</span>(<span class="params">alist</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;选择排序(不稳定|n^2)&quot;&quot;&quot;</span></span><br><span class="line">    n = len(alist)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(n<span class="number">-1</span>):</span><br><span class="line">        min_index = j</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(j+<span class="number">1</span>,n):</span><br><span class="line">            <span class="keyword">if</span> alist[min_index] &gt; alist[i]:</span><br><span class="line">                min_index = i</span><br><span class="line">        alist[j], alist[min_index] = alist[min_index], alist[j]</span><br></pre></td></tr></table></figure>
<h2 id="三、插入排序"><a href="#三、插入排序" class="headerlink" title="三、插入排序"></a>三、插入排序</h2><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def insert_sort(alist):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;插入排序(稳定|n^2)&quot;&quot;&quot;</span></span><br><span class="line">    n = len(alist)</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">j</span> in range(<span class="number">1</span>,n):</span><br><span class="line">        <span class="built_in">i</span> = <span class="built_in">j</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">i</span>&gt;<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> alist[<span class="built_in">i</span>] &lt; alist[<span class="built_in">i</span><span class="number">-1</span>]:</span><br><span class="line">                alist[<span class="built_in">i</span>], alist[<span class="built_in">i</span><span class="number">-1</span>] = alist[<span class="built_in">i</span><span class="number">-1</span>], alist[<span class="built_in">i</span>]</span><br><span class="line">                <span class="built_in">i</span> -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span> </span><br></pre></td></tr></table></figure>
<h2 id="四、希尔排序"><a href="#四、希尔排序" class="headerlink" title="四、希尔排序"></a>四、希尔排序</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def shell_sort(alist):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;希尔排序(不稳定|n^2)&quot;&quot;&quot;</span></span><br><span class="line">    n = len(alist)</span><br><span class="line">    gap = n<span class="regexp">//</span><span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> gap&gt;=<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(gap,n):</span><br><span class="line">            i=j</span><br><span class="line">            <span class="keyword">while</span> i&gt;<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> alist[i]&lt;alist[i-gap]:</span><br><span class="line">                    alist[i], alist[i-gap] = alist[i-gap], alist[i]</span><br><span class="line">                    i -= gap</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        gap <span class="regexp">//</span>=<span class="number">2</span></span><br></pre></td></tr></table></figure>
<h2 id="五、快速排序"><a href="#五、快速排序" class="headerlink" title="五、快速排序"></a>五、快速排序</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quick_sort</span>(<span class="params">alist, first, last</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;快速排序(不稳定|n^2)&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> first &gt;= last:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    mid_value = alist[first]</span><br><span class="line">    low = first</span><br><span class="line">    high = last</span><br><span class="line">    <span class="keyword">while</span> low &lt; high:</span><br><span class="line">        <span class="comment">#high左移</span></span><br><span class="line">        <span class="keyword">while</span> low &lt;high <span class="keyword">and</span> alist[high] &gt;= mid_value:</span><br><span class="line">            high -= <span class="number">1</span></span><br><span class="line">        alist[low] = alist[high]</span><br><span class="line">        <span class="comment">#low右移</span></span><br><span class="line">        <span class="keyword">while</span> low &lt; high <span class="keyword">and</span> alist[low] &lt; mid_value:</span><br><span class="line">            low += <span class="number">1</span></span><br><span class="line">        alist[high] =alist[low]  </span><br><span class="line">    <span class="comment">#从循环退出时，low=high</span></span><br><span class="line">    alist[low] = mid_value</span><br><span class="line"></span><br><span class="line">    <span class="comment">#对low左边的列表执行快速排序</span></span><br><span class="line">    quick_sort(alist, first, low<span class="number">-1</span>)</span><br><span class="line">    <span class="comment">#对low右边的列表执行快速排序</span></span><br><span class="line">    quick_sort(alist, low+<span class="number">1</span>, last)</span><br></pre></td></tr></table></figure>
<h2 id="六、归并排序"><a href="#六、归并排序" class="headerlink" title="六、归并排序"></a>六、归并排序</h2><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">def merge_sort(alist):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;归并排序(稳定|nlgn)&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    n = <span class="built_in">len</span>(alist)</span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="literal">return</span> alist</span><br><span class="line">    <span class="keyword">mid</span> = <span class="comment">n//2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#left 采用归并排序后形成新的有序列表</span></span><br><span class="line">    left_li = merge_sort(alist[:<span class="keyword">mid</span>])</span><br><span class="line">    <span class="comment">#right 采用归并排序后形成新的有序列表</span></span><br><span class="line">    right_li = merge_sort(alist[<span class="keyword">mid</span>:])</span><br><span class="line"></span><br><span class="line">    <span class="comment">#merge(left, right) 将两个有序的子序列合并为一个新的整体</span></span><br><span class="line">    left_pointer, right_pointer = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="built_in">result</span> = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> left_pointer &lt; <span class="built_in">len</span>(left_li) <span class="keyword">and</span> right_pointer&lt;<span class="built_in">len</span>(right_li):</span><br><span class="line">        <span class="keyword">if</span> left_li[left_pointer] &lt; right_li[right_pointer]:</span><br><span class="line">            <span class="built_in">result</span>.append(left_li[left_pointer])</span><br><span class="line">            left_pointer += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">result</span>.append(right_li[right_pointer])</span><br><span class="line">            right_pointer += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">result</span> += left_li[left_pointer:]</span><br><span class="line">    <span class="built_in">result</span> += right_li[right_pointer:]</span><br><span class="line">    <span class="literal">return</span> <span class="built_in">result</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/03/Python%20Twisted%E5%BC%82%E6%AD%A5%E5%86%99%E5%85%A5Mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Leo Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江湖の林九">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/03/Python%20Twisted%E5%BC%82%E6%AD%A5%E5%86%99%E5%85%A5Mysql/" class="post-title-link" itemprop="url">Python Twisted异步写入Mysql</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-03 11:00:05" itemprop="dateCreated datePublished" datetime="2019-11-03T11:00:05+08:00">2019-11-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-24 09:55:28" itemprop="dateModified" datetime="2020-04-24T09:55:28+08:00">2020-04-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%B6%B3%E8%BF%B9/" itemprop="url" rel="index"><span itemprop="name">编程足迹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="导入模块"><a href="#导入模块" class="headerlink" title="导入模块"></a>导入模块</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> twisted.enterprise <span class="keyword">import</span> adbapi</span><br></pre></td></tr></table></figure>

<h2 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h2><p>事务:如果所有语句都执行正确,才真正执行,只要有一条数据出错,可以通过回滚撤销所有操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MysqlTwistedPipeline</span>:</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    利用twisted api实现异步入库Mysql的功能，</span></span><br><span class="line"><span class="string">    Twisted提供的是一个异步的容器，</span></span><br><span class="line"><span class="string">    本身没提供数据库链接</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, dbpool</span>):</span></span><br><span class="line">        self.dbpool = dbpool</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_settings</span>(<span class="params">cls, settings</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        from_settings被spider调用,将settings传递进来并读取配置参数</span></span><br><span class="line"><span class="string">        :param settings:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        dbparams = dict(host=settings.get(<span class="string">&quot;MYSQL_HOST&quot;</span>),</span><br><span class="line">                        db=settings.get(<span class="string">&quot;MYSQL_DBNAME&quot;</span>),</span><br><span class="line">                        user=settings.get(<span class="string">&#x27;MYSQL_USER&#x27;</span>),</span><br><span class="line">                        passwd=settings.get(<span class="string">&#x27;MYSQL_PASSWORD&#x27;</span>),</span><br><span class="line">                        charset=<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># twisted 中的 adbapi 能够将sql操作转变成异步操作生成连接池</span></span><br><span class="line">        pool = adbapi.ConnectionPool(<span class="string">&quot;pymysql&quot;</span>, **dbparams)</span><br><span class="line">		<span class="comment"># cls把参数给__init__</span></span><br><span class="line">        <span class="keyword">return</span> cls(pool)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        使用twisted将mysql操作变成异步执行</span></span><br><span class="line"><span class="string">        :param item:</span></span><br><span class="line"><span class="string">        :param spider:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># runInteraction可以将传入的函数变成异步的并返回一个对象</span></span><br><span class="line">        query = self.dbpool.runInteraction(self.do_insert, item)</span><br><span class="line">        <span class="comment"># handle exceptions 当执行过程中出现错误,执行adderrback</span></span><br><span class="line">        query.addErrback(self.handle_error)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_error</span>(<span class="params">self, failure</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        处理异步操作的异常</span></span><br><span class="line"><span class="string">        :param failure:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        print(<span class="string">f&quot;failure:<span class="subst">&#123;failure&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_insert</span>(<span class="params">self, cursor, item</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        从dbpool取出cursor进行插入操作，twisted会自动完成commit</span></span><br><span class="line"><span class="string">        :param cursor:</span></span><br><span class="line"><span class="string">        :param item:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        insert_sql = <span class="string">&quot;&quot;&quot;insert into article(title, create_date, url, url_object_id, front_img_url, front_img_path, </span></span><br><span class="line"><span class="string">        comment_nums,fav_nums,vote_nums, tags, content) VALUES (&#x27;%s&#x27;, &#x27;%s&#x27;, &#x27;%s&#x27;,&#x27;%s&#x27;, &#x27;%s&#x27;,&#x27;%s&#x27;,%d,%d, %d,&#x27;%s&#x27;,&#x27;%s&#x27;);</span></span><br><span class="line"><span class="string">         &quot;&quot;&quot;</span> % (item[<span class="string">&quot;title&quot;</span>], item[<span class="string">&quot;create_date&quot;</span>], item[<span class="string">&quot;url&quot;</span>], item[<span class="string">&quot;url_object_id&quot;</span>], item[<span class="string">&quot;front_image_url&quot;</span>],</span><br><span class="line">                item[<span class="string">&quot;image_url_path&quot;</span>], item[<span class="string">&quot;comment_nums&quot;</span>], item[<span class="string">&#x27;fav_nums&#x27;</span>], item[<span class="string">&quot;vote_nums&quot;</span>], item[<span class="string">&quot;tags&quot;</span>],</span><br><span class="line">                item[<span class="string">&quot;content&quot;</span>])</span><br><span class="line"></span><br><span class="line">        cursor.execute(insert_sql)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/03/Python%20Json%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Leo Lin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江湖の林九">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/03/Python%20Json%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">Python Json模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-03 10:24:00" itemprop="dateCreated datePublished" datetime="2019-11-03T10:24:00+08:00">2019-11-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-24 09:48:05" itemprop="dateModified" datetime="2020-04-24T09:48:05+08:00">2020-04-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E8%B6%B3%E8%BF%B9/" itemprop="url" rel="index"><span itemprop="name">编程足迹</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Python的字典key可以是任意可hash对象。<br>Json是根据某种约定格式编写的纯字符串，它的key只能是字符串形式。</p>
<h2 id="json-dump-load"><a href="#json-dump-load" class="headerlink" title="json dump/load"></a>json dump/load</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 处理的是文件而不是字符串</span></span><br><span class="line"><span class="comment"># 写入 JSON 数据</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    json.dump(data, f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取数据</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = json.load(f)</span><br><span class="line">    print(data, type(data))</span><br></pre></td></tr></table></figure>

<h2 id="json-dumps-loads"><a href="#json-dumps-loads" class="headerlink" title="json dumps/loads"></a>json dumps/loads</h2><p>json.dumps序列化时默认使用的ascii编码，想输出真正的中文需要指定ensure_ascii=False。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">json.dumps(<span class="string">&#x27;中国&#x27;</span>)</span><br><span class="line"><span class="comment"># &#x27;&quot;\\u4e2d\\u56fd&quot;&#x27;</span></span><br><span class="line">json.dumps(<span class="string">&#x27;中国&#x27;</span>,ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># &#x27;&quot;中国&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Json解码时创建其他类型的对象,解码后的字典作为一个单个参数传递给 __init__()</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSONObject</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, d</span>):</span></span><br><span class="line">        self.__dict__ = d</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"></span><br><span class="line">data = json.loads(s, object_pairs_hook=OrderedDict)</span><br><span class="line">data2 = json.loads(s, object_hook=JSONObject)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>1、json.decoder.JSONDecodeError: Invalid control character ?<br><strong>解决方案</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">json_str &#x3D; json.loads(jsonString, strict&#x3D;False)</span><br></pre></td></tr></table></figure>
<p>根据JSON规范，有效字符是：</p>
<ul>
<li>除了：”，\和控制字符（ord(char) &lt; 32）之外的任何Unicode字符。</li>
<li>下列字符序列被允许：&quot;，\，/，\b（退格键）， \f（换）， \n（换行/新行）， \r（回车）， \t（制表符），或者\u随后四个十六进制数字。<br>但是在Python中需要将转义控制字符加倍（除非字符串是原始的），因为Python也会解释这些控制字符。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Leo Lin"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Leo Lin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">104</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leo Lin</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>


    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
